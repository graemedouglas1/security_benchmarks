---

# Section 1

- name: "SCORED | 1.1.1 | POLICY | L1 Ensure Enforce password history is set to 24 or more passwords"
  win_security_policy:
    section: System Access
    key: PasswordHistorySize
    value: "{{ passwordhistorysize }}"
  when: cis[2019]['1.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.1

- name: "SCORED | 1.1.2 | POLICY | L1 Ensure Maximum password age is set to 60 or fewer days but not 0"
  win_security_policy:
    section: System Access
    key: MaximumPasswordAge
    value: "{{ maximumpasswordage }}"
  when: cis[2019]['1.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.2

- name: "SCORED | 1.1.3 | POLICY | L1 Ensure Minimum password age is set to 1 or more days"
  win_security_policy:
    section: System Access
    key: MinimumPasswordAge
    value: "{{ minimumpasswordage }}"
  when: cis[2019]['1.1.3']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.3

- name: "SCORED | 1.1.4 | POLICY | L1 Ensure Minimum password length is set to 14 or more characters"
  win_security_policy:
    section: System Access
    key: MinimumPasswordLength
    value: "{{ minimumpasswordlength }}"
  when: cis[2019]['1.1.4']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.4

- name: "SCORED | 1.1.5 | POLICY | L1 Ensure Password must meet complexity requirements is set to Enabled"
  win_security_policy:
    section: System Access
    key: PasswordComplexity
    value: 1
  when: cis[2019]['1.1.5']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.5

- name: "SCORED | 1.1.6 | POLICY | L1 Ensure Store passwords using reversible encryption is set to Disabled"
  win_security_policy:
    section: System Access
    key: ClearTextPassword
    value: "0"
  when: cis[2019]['1.1.6']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.6

- name: "SCORED | 1.2.1 | POLICY | L1 Ensure Account lockout duration is set to 15 or more minutes"
  win_security_policy:
    section: System Access
    key: LockoutDuration
    value: "{{ lockoutduration }}"
  when:
    - cis[2019]['1.2.1']
    - is_implemented
  tags:
    - domaincontroller
    - memberserver
    - control_1.2.1

# This rule must be applied first to make control_1.2.1 and control_1.2.3 applicable
- name: "SCORED | 1.2.2 | POLICY | L1 Ensure Account lockout threshold is set to 10 or fewer invalid logon attempts but not 0"
  win_security_policy:
    section: System Access
    key: LockoutBadCount
    value: "{{ lockoutbadcount }}"
  when: cis[2019]['1.2.2']
  tags:
    - domaincontroller
    - memberserver
    - control_1.2.2

- name: "SCORED | 1.2.3 | POLICY | L1 Ensure Reset account lockout counter after is set to 15 or more minutes"
  win_security_policy:
    section: System Access
    key: ResetLockoutCount
    value: "{{ resetlockoutcount }}"
  when: cis[2019]['1.2.3']
  tags:
    - domaincontroller
    - memberserver
    - control_1.2.3

# Section 2

- name: "SCORED | 2.2.1 | POLICY | L1 Ensure Access Credential Manager as a trusted caller is set to No One"
  win_user_right:
    name: SeTrustedCredManAccessPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.1

- name: "SCORED | 2.2.2 & 2.2.3 | POLICY | L1 Ensure Access this computer from the network is set to Administrators Authenticated Users ENTERPRISE DOMAIN CONTROLLERS DC only"
  win_user_right:
    name: SeNetworkLogonRight
    users:
      - Administrators
      - Authenticated Users
    action: set
  when:
    - cis[2019]['2.2.2'] or cis[2019]['2.2.3']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.2
    - control_2.2.3

- name: "SCORED | 2.2.4 | POLICY | L1 Ensure Act as part of the operating system is set to No One"
  win_user_right:
    name: SeTcbPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.4

- name: "SCORED | 2.2.5 | POLICY | L1 Ensure Add workstations to domain is set to Administrators DC only"
  win_user_right:
    name: SeMachineAccountPrivilege
    users: Administrators
    action: set
  when:
    - cis[2019]['2.2.5']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.5

- name: "SCORED | 2.2.6 | POLICY | L1 Ensure Adjust memory quotas for a process is set to Administrators LOCAL SERVICE NETWORK SERVICE"
  win_user_right:
    name: SeIncreaseQuotaPrivilege
    users:
      - Administrators
      - Local Service
      - Network Service
    action: set
  when: cis[2019]['2.2.6']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.6

- name: "SCORED | 2.2.7 | POLICY | L1 Ensure Allow log on locally is set to Administrators"
  win_user_right:
    name: SeInteractiveLogonRight
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.7']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.7

- name: "SCORED | 2.2.8 & 2.2.9 | POLICY | L1 Ensure Allow log on through Remote Desktop Services is set to Administrators DC only"
  win_user_right:
      name: SeRemoteInteractiveLogonRight
      users:
          - Administrators
          - Remote Desktop Users
      action: set
  when:
    - ansible_windows_domain_role == "Primary domain controller"
    - cis[2019]['2.2.8'] or cis[2019]['2.2.9']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.8
    - control_2.2.9

- name: "SCORED | 2.2.10 | POLICY | L1 Ensure Back up files and directories is set to Administrators"
  win_user_right:
    name: SeBackupPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.10']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.10

- name: "SCORED | 2.2.11 | POLICY | L1 Ensure Change the system time is set to Administrators LOCAL SERVICE"
  win_user_right:
    name: SeSystemTimePrivilege
    users:
      - Administrators
      - Local Service
    action: set
  when: cis[2019]['2.2.11']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.11

- name: "SCORED | 2.2.12 | POLICY | L1 Ensure Change the time zone is set to Administrators LOCAL SERVICE"
  win_user_right:
      name: SeTimeZonePrivilege
      users:
          - Administrators
          - Local Service
      action: set
  when: cis[2019]['2.2.12']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.12

- name: "SCORED | 2.2.13 | POLICY | L1 Ensure Create a pagefile is set to Administrators"
  win_user_right:
    name: SeCreatePagefilePrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.13']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.13

- name: "SCORED | 2.2.14 | POLICY | L1 Ensure Create a token object is set to No One"
  win_user_right:
    name: SeCreateTokenPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.14']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.14

- name: "SCORED | 2.2.15 | POLICY | L1 Ensure Create global objects is set to Administrators LOCAL SERVICE NETWORK SERVICE SERVICE"
  win_user_right:
    name: SeCreateGlobalPrivilege
    users:
      - Administrators
      - Local Service
      - Network Service
      - Service
    action: set
  when: cis[2019]['2.2.15']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.15

- name: "SCORED | 2.2.16 | POLICY | L1 Ensure Create permanent shared objects is set to No One"
  win_user_right:
    name: SeCreatePermanentPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.16']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.16

- name: "SCORED | 2.2.17 | POLICY | L1 Ensure Create symbolic links is set to Administrators DC only"
  win_user_right:
    name: SeCreateSymbolicLinkPrivilege
    users:
      - Administrators
    action: set
  when:
    - cis[2019]['2.2.17']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.17

- name: "SCORED | 2.2.18 | POLICY | L1 Ensure Create symbolic links is set to Administrators NT VIRTUAL MACHINEVirtual Machines MS only"
  win_user_right:
    name: SeCreateSymbolicLinkPrivilege
    users:
      - Administrators
      - NT VIRTUAL MACHINE\Virtual Machines
    action: set
  when:
    - is_hyperv_installed
    - cis[2019]['2.2.18']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - memberserver
    - control_2.2.18

- name: "SCORED | 2.2.19 | POLICY | L1 Ensure Debug programs is set to Administrators"
  win_user_right:
      name: SeDebugPrivilege
      users:
        - Administrators
      action: set
  when: cis[2019]['2.2.19']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.19

# Limiting hardening to only include the Guests group, since Local Account access will still be needed for non-domain-joined nodes
- name: "SCORED | 2.2.20 | POLICY | L1 Ensure Deny access to this computer from the network to include Guests DC only"
  win_user_right:
    name: SeDenyNetworkLogonRight
    users:
      - Guests
    action: set
  when:
    - cis[2019]['2.2.20']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.20

- name: "SCORED | 2.2.21 | POLICY | L1 Ensure Deny access to this computer from the network to include Guests Local account and member of Administrators group MS only"
  win_user_right:
    name: SeDenyNetworkLogonRight
    users:
      - Guests
      #- Local Account
      #- Administrators
    action: set
  when:
    - cis[2019]['2.2.21']
    - ansible_windows_domain_member
  tags:
    - memberserver
    - control_2.2.21

- name: "SCORED | 2.2.22 | POLICY | L1 Ensure Deny log on as a batch job to include Guests"
  win_user_right:
    name: SeDenyBatchLogonRight
    users:
      - Guests
    action: set
  when: cis[2019]['2.2.22']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.22


- name: "SCORED | 2.2.23 | POLICY | L1 Ensure Deny log on as a service to include Guests"
  win_user_right:
    name: SeDenyServiceLogonRight
    users:
      - Guests
    action: set
  when: cis[2019]['2.2.23']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.23

- name: "SCORED | 2.2.24 | POLICY | L1 Ensure Deny log on locally to include Guests"
  win_user_right:
    name: SeDenyInteractiveLogonRight
    users:
      - Guests
    action: set
  when: cis[2019]['2.2.24']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.24

- name: "SCORED | 2.2.25 | POLICY | L1 Ensure Deny log on through Remote Desktop Services to include Guests DC only"
  win_user_right:
    name: SeDenyRemoteInteractiveLogonRight
    users:
      - Guests
      #- Local Account
    action: set
  when: 
    - cis[2019]['2.2.25']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.25

- name: "SCORED | 2.2.26 | POLICY | L1 Ensure Deny log on through Remote Desktop Services is set to Guests Local account MS only"
  win_user_right:
    name: SeDenyRemoteInteractiveLogonRight
    users:
      - Guests
      #- Local Account
    action: set
  when: 
    - cis[2019]['2.2.26']
    - ansible_windows_domain_member
  tags:
    - memberserver
    - control_2.2.26

- name: "SCORED | 2.2.27 | POLICY | L1 Ensure Enable computer and user accounts to be trusted for delegation is set to Administrators DC only"
  win_user_right:
    name: SeEnableDelegationPrivilege
    users: Administrators
    action: set
  when:
    - cis[2019]['2.2.27']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.27

- name: "SCORED | 2.2.28 | POLICY | L1 Ensure Enable computer and user accounts to be trusted for delegation is set to No One MS only"
  win_user_right:
    name: SeEnableDelegationPrivilege
    users: []
    action: set
  when:
    - cis[2019]['2.2.28']
    - ansible_windows_domain_member
  tags:
    - memberserver
    - control_2.2.28

- name: "SCORED | 2.2.29 | POLICY | L1 Ensure Force shutdown from a remote system is set to Administrators"
  win_user_right:
    name: SeRemoteShutdownPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.29']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.29

- name: "SCORED | 2.2.30 | POLICY | L1 Ensure Generate security audits is set to LOCAL SERVICE NETWORK SERVICE"
  win_user_right:
    name: SeAuditPrivilege
    users:
      - Local Service
      - Network Service
    action: set
  when: cis[2019]['2.2.30']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.30

- name: "SCORED | 2.2.31 | POLICY | L1 Ensure Impersonate a client after authentication is set to Administrators LOCAL SERVICE NETWORK SERVICE SERVICE DC only"
  win_user_right:
    name: SeImpersonatePrivilege
    users:
      - Administrators
      - Local Service
      - Network Service
      - Service
    action: set
  when:
    - cis[2019]['2.2.31']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.31

- name: "SCORED | 2.2.32 | POLICY | L1 Ensure Impersonate a client after authentication is set to Administrators LOCAL SERVICE NETWORK SERVICE SERVICE and when the Web Server IIS Role with Web Services Role Service is installed IIS IUSRS MS only"
  win_user_right:
    name: SeImpersonatePrivilege
    users:
      - Administrators
      - IIS_IUSRS
      - Local Service
      - Network Service
      - Service
    action: set
  when:
    - cis[2019]['2.2.32']
    - ansible_windows_domain_member
  tags:
    - memberserver
    - control_2.2.32

- name: "SCORED | 2.2.33 | POLICY | L1 Ensure Increase scheduling priority is set to Administrators Window ManagerWindow Manager Group"
  win_user_right:
    name: SeIncreaseBasePriorityPrivilege
    users:
      - Administrators
      - Window Manager\Window Manager Group
    action: set
  when: cis[2019]['2.2.33']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.33

- name: "SCORED | 2.2.34 | POLICY | L1 Ensure Load and unload device drivers is set to Administrators"
  win_user_right:
    name: SeLoadDriverPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.34']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.34

- name: "SCORED | 2.2.35 | POLICY | L1 Ensure Lock pages in memory is set to No One"
  win_user_right:
    name: SeLockMemoryPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.35']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.35

- name: "SCORED | 2.2.37 & 2.2.38 | POLICY | L1 Ensure Manage auditing and security log is set to Administrators and when Exchange is running in the environment Exchange Servers DC only"
  win_user_right:
    name: SeSecurityPrivilege
    users:
      - Administrators
    action: set
  when:
    - cis[2019]['2.2.37'] or cis[2019]['2.2.38']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.37
    - control_2.2.38

- name: "SCORED | 2.2.39 | POLICY | L1 Ensure Modify an object label is set to No One"
  win_user_right:
    name: SeReLabelPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.39']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.39

- name: "SCORED | 2.2.40 | POLICY | L1 Ensure Modify firmware environment values is set to Administrators"
  win_user_right:
    name: SeSystemEnvironmentPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.40']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.40

- name: "SCORED | 2.2.41 | POLICY | L1 Ensure Perform volume maintenance tasks is set to Administrators"
  win_user_right:
    name: SeManageVolumePrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.41']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.41

- name: "SCORED | 2.2.42 | POLICY | L1 Ensure Profile single process is set to Administrators"
  win_user_right:
    name: SeProfileSingleProcessPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.42']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.42

- name: "SCORED | 2.2.43 | POLICY | L1 Ensure Profile system performance is set to Administrators NT SERVICEWdiServiceHost"
  win_user_right:
    name: SeSystemProfilePrivilege
    users:
      - Administrators
      - NT SERVICE\WdiServiceHost
    action: set
  when: cis[2019]['2.2.43']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.43

- name: "SCORED | 2.2.44 | POLICY | L1 Ensure Replace a process level token is set to LOCAL SERVICE NETWORK SERVICE"
  win_user_right:
    name: SeAssignPrimaryTokenPrivilege
    users:
      - LOCAL SERVICE
      - NETWORK SERVICE
    action: set
  when: cis[2019]['2.2.44']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.44

- name: "SCORED | 2.2.45 | POLICY | L1 Ensure Restore files and directories is set to Administrators"
  win_user_right:
    name: SeRestorePrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.45']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.45

- name: "SCORED | 2.2.46 | POLICY | L1 Ensure Shut down the system is set to Administrators"
  win_user_right:
    name: SeShutdownPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.46']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.46

- name: "SCORED | 2.2.47 | POLICY | L1 Ensure Synchronize directory service data is set to No One DC only"
  win_user_right:
    name: SeSyncAgentPrivilege
    users: []
    action: set
  when:
    - cis[2019]['2.2.47']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.47

- name: "SCORED | 2.2.48 | POLICY | L1 Ensure Take ownership of files or other objects is set to Administrators"
  win_user_right:
    name: SeTakeOwnershipPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.48']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.48

- name: "SCORED | 2.3.1.1 | POLICY | L1 Ensure Accounts Administrator account status is set to Disabled MS only"
  win_security_policy:
    section: System Access
    key: EnableAdminAccount
    value: 0
  when:
    - cis[2019]['2.3.1.1']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - memberserver
    - control_2.3.1.1

- name: "SCORED | 2.3.1.2 | POLICY | L1 Ensure Accounts Block Microsoft accounts is set to Users cant add or log on with Microsoft accounts"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: NoConnectedUser
    data: 3
    type: dword
  when: cis[2019]['2.3.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.1.2

- name: "SCORED | 2.3.1.3 | POLICY | L1 Ensure Accounts Guest account status is set to Disabled MS only"
  win_security_policy:
    section: System Access
    key: EnableGuestAccount
    value: 0
  when: cis[2019]['2.3.1.3']
  tags:
    - memberserver
    - control_2.3.1.3

- name: "SCORED | 2.3.1.4 | POLICY | L1 Ensure Accounts Limit local account use of blank passwords to console logon only is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: LimitBlankPasswordUse
    data: 1
    type: dword
  when: cis[2019]['2.3.1.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.1.4

- name: "SCORED | 2.3.1.5 | POLICY | L1 Configure Accounts Rename administrator account"
  win_security_policy:
    section: System Access
    key: newadministratorname
    value: "{{ win19cis_admin_username }}"
  when:
    - cis[2019]['2.3.1.5']
    - not win_skip_for_test
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.1.5

- name: "SCORED | 2.3.1.6 | POLICY | L1 Configure Accounts Rename guest account"
  win_security_policy:
    section: System Access
    key: NewGuestName
    value: "{{ win19cis_guest_username }}"
  when: cis[2019]['2.3.1.6']
  tags:
    - domaincontroller
    - memberservers
    - control_2.3.1.6

- name: "SCORED | 2.3.2.1 | POLICY | L1 Ensure Audit Force audit policy subcategory settings Windows Vista or later to override audit policy category settings is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: SCENoApplyLegacyAuditPolicy
    data: 1
    type: dword
  when: cis[2019]['2.3.2.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.2.1

- name: "SCORED | 2.3.2.2 | POLICY | L1 Ensure Audit Shut down system immediately if unable to log security audits is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: CrashOnAuditFail
    data: 0
    type: dword
  when: cis[2019]['2.3.2.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.2.2

- name: "SCORED | 2.3.4.1 | POLICY | L1 Ensure Devices Allowed to format and eject removable media is set to Administrators"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
    name: AllocateDASD
    data: 0
    type: string
  when: cis[2019]['2.3.4.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.4.1

- name: "SCORED | 2.3.4.2 | POLICY | L1 Ensure Devices Prevent users from installing printer drivers is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Print\Providers\Lanman Print Services\Servers
    name: AddPrinterDrivers
    data: 1
    type: dword
  when: cis[2019]['2.3.4.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.4.2

- name: "SCORED | 2.3.5.1 | POLICY | L1 Ensure Domain controller Allow server operators to schedule tasks is set to Disabled DC only"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: SubmitControl
    data: 0
    type: dword
  when:
    - cis[2019]['2.3.5.1']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.3.5.1

- name: "SCORED | 2.3.5.2 | POLICY | L1 Ensure Domain controller LDAP server signing requirements is set to Require signing DC only"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\NTDS\Parameters
    name: LDAPServerIntegrity
    data: 2
    type: dword
  when:
    - cis[2019]['2.3.5.2']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.3.5.2

- name: "SCORED | 2.3.5.3 | POLICY | L1 Ensure Domain controller Refuse machine account password changes is set to Disabled DC only"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters
    name: RefusePasswordChange
    data: 0
    type: dword
  when:
    - cis[2019]['2.3.5.3']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.3.5.3

- name: "SCORED | 2.3.6.1 | POLICY | L1 Ensure Domain member Digitally encrypt or sign secure channel data always is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: RequireSignOrSeal
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.6.1']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.1

- name: "SCORED | 2.3.6.2 | POLICY | L1 Ensure Domain member Digitally encrypt secure channel data when possible is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: sealsecurechannel
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.6.2']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.2

- name: "SCORED | 2.3.6.3 | POLICY | L1 Ensure Domain member Digitally sign secure channel data when possible is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: signsecurechannel
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.6.3']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.3

- name: "SCORED | 2.3.6.4 | POLICY | L1 Ensure Domain member Disable machine account password changes is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: disablepasswordchange
    data: 0
    type: dword
  when:
    - cis[2019]['2.3.6.4']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.4

- name: "SCORED | 2.3.6.5 | POLICY | L1 Ensure Domain member Maximum machine account password age is set to 30 or fewer days but not 0"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: MaximumPasswordAge
    data: 30
    type: dword
  when:
    - cis[2019]['2.3.6.5']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.5

- name: "SCORED | 2.3.6.6 | POLICY | L1 Ensure Domain member Require strong Windows 2000 or later session key is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: RequireStrongKey
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.6.6']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.6

- name: "SCORED | 2.3.7.1 | POLICY | L1 Ensure Interactive logon Do not require CTRLALTDEL is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: DisableCAD
    data: 0
    type: dword
  when: cis[2019]['2.3.7.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.1

- name: "SCORED | 2.3.7.2 | POLICY | L1 Ensure Interactive logon Dont display last signed-in is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: DontDisplayLastUserName
    data: 1
    type: dword
  when: cis[2019]['2.3.7.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.2

- name: "SCORED | 2.3.7.3 | POLICY | L1 Ensure Interactive logon Machine inactivity limit is set to 900 or fewer seconds but not 0"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: InactivityTimeoutSecs
    data: 900
    type: dword
  when: cis[2019]['2.3.7.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.3

- name: "SCORED | 2.3.7.4 | POLICY | L1 Configure Interactive logon Message text for users attempting to log on"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: LegalNoticeText
    data: "{{ legalnoticetext }}"
    type: string
  when: cis[2019]['2.3.7.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.4

- name: "SCORED | 2.3.7.5 | POLICY | L1 Configure Interactive logon Message title for users attempting to log on"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: LegalNoticeCaption
    data: "{{ legalnoticecaption }}"
    type: string
  when: cis[2019]['2.3.7.5']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.5

- name: "SCORED | 2.3.7.7 | POLICY | L1 Ensure Interactive logon Prompt user to change password before expiration is set to between 5 and 14 days"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
    name: PasswordExpiryWarning
    data: 14
    type: dword
  when: cis[2019]['2.3.7.7']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.7

- name: "SCORED | 2.3.7.8 | POLICY | L1 Ensure Interactive logon Require Domain Controller Authentication to unlock workstation is set to Enabled MS only"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
    name: ForceUnlockLogon
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.7.8']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.7.8

- name: "SCORED | 2.3.7.9 | POLICY | L1 Ensure Interactive logon Smart card removal behavior is set to Lock Workstation or higher"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
    name: scremoveoption
    data: 1
    type: string
  when: cis[2019]['2.3.7.9']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.9

- name: "SCORED | 2.3.8.1 | POLICY | L1 Ensure Microsoft network client Digitally sign communications always is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters
    name: RequireSecuritySignature
    data: 1
    type: dword
  when: cis[2019]['2.3.8.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.8.1

- name: "SCORED | 2.3.8.2 | POLICY | L1 Ensure Microsoft network client Digitally sign communications if server agrees is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters
    name: EnableSecuritySignature
    data: 1
    type: dword
  when: cis[2019]['2.3.8.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.8.2

- name: "SCORED | 2.3.8.3 | POLICY | L1 Ensure Microsoft network client Send unencrypted password to third-party SMB servers is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters
    name: EnablePlainTextPassword
    data: 0
    type: dword
  when: cis[2019]['2.3.8.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.8.3

- name: "SCORED | 2.3.9.1 | POLICY | L1 Ensure Microsoft network server Amount of idle time required before suspending session is set to 15 or fewer minutes"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: autodisconnect
    data: 15
    type: dword
  when: cis[2019]['2.3.9.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.9.1

- name: "SCORED | 2.3.9.2 | POLICY | L1 Ensure Microsoft network server Digitally sign communications always is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: requiresecuritysignature
    data: 1
    type: dword
  when: cis[2019]['2.3.9.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.9.2

- name: "SCORED | 2.3.9.3 | POLICY | L1 Ensure Microsoft network server Digitally sign communications if client agrees is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: enablesecuritysignature
    data: 1
    type: dword
  when: cis[2019]['2.3.9.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.9.3

- name: "SCORED | 2.3.9.4 | POLICY | L1 Ensure Microsoft network server Disconnect clients when logon hours expire is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: enableforcedlogoff
    data: 1
    type: dword
  when: cis[2019]['2.3.9.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.9.4

- name: "SCORED | 2.3.9.5 | POLICY | L1 Ensure Microsoft network server Server SPN target name validation level is set to Accept if provided by client or higher MS only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: SMBServerNameHardeningLevel
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.9.5']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.9.5

- name: "SCORED | 2.3.10.1 | POLICY | L1 Ensure Network access Allow anonymous SIDName translation is set to Disabled"
  win_security_policy:
    section: System Access
    key: LSAAnonymousNameLookup
    value: 0
  when: cis[2019]['2.3.10.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.1

- name: "SCORED | 2.3.10.2 | POLICY | L1 Ensure Network access Do not allow anonymous enumeration of SAM accounts is set to Enabled MS only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: RestrictAnonymousSAM
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.10.2']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.10.2

- name: "SCORED | 2.3.10.3 | POLICY | L1 Ensure Network access Do not allow anonymous enumeration of SAM accounts and shares is set to Enabled MS only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: RestrictAnonymous
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.10.3']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.10.3

- name: "SCORED | 2.3.10.5 | POLICY | L1 Ensure Network access Let Everyone permissions apply to anonymous users is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: EveryoneIncludesAnonymous
    data: 0
    type: dword
  when: cis[2019]['2.3.10.5']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.5

- name: "SCORED | 2.3.10.6 | POLICY | L1 Configure Network access Named Pipes that can be accessed anonymously DC only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: NullSessionPipes
    data: ""
    type: multistring
  when:
    - cis[2019]['2.3.10.6']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.3.10.6

- name: "SCORED | 2.3.10.7 | POLICY | L1 Configure Network access Named Pipes that can be accessed anonymously MS only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: NullSessionPipes
    data: ""
    type: multistring
  when:
    - cis[2019]['2.3.10.7']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.10.7


- name: "SCORED | 2.3.10.8 | POLICY | L1 Configure Network access Remotely accessible registry paths"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Securepipeservers\Winreg\AllowedExactpaths
    name: "Machine"
    data: ['System\CurrentControlSet\Control\ProductOptions', 'System\CurrentControlSet\Control\Server Applications', 'Software\Microsoft\Windows NT\CurrentVersion']
    type: multistring
  when: cis[2019]['2.3.10.8']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.8

- name: "SCORED | 2.3.10.9 | POLICY | L1 Configure Network access Remotely accessible registry paths and sub-paths"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Securepipeservers\Winreg\Allowedpaths
    name: "Machine"
    data: ['System\CurrentControlSet\Control\Print\Printers', 'System\CurrentControlSet\Services\Eventlog', 'Software\Microsoft\OLAP Server', 'Software\Microsoft\Windows NT\CurrentVersion\Print', 'Software\Microsoft\Windows NT\CurrentVersion\Windows', 'System\CurrentControlSet\Control\ContentIndex', 'System\CurrentControlSet\Control\Terminal Server', 'System\CurrentControlSet\Control\Terminal Server\UserConfig', 'System\CurrentControlSet\Control\Terminal Server\DefaultUserConfiguration', 'Software\Microsoft\Windows NT\CurrentVersion\Perflib', 'System\CurrentControlSet\Services\WINS', 'System\CurrentControlSet\Services\CertSvc']
    type: multistring
  when: cis[2019]['2.3.10.9']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.9

- name: "SCORED | 2.3.10.10 | POLICY | L1 Ensure Network access Restrict anonymous access to Named Pipes and Shares is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: RestrictNullSessAccess
    data: 1
    type: dword
  when: cis[2019]['2.3.10.10']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.10

- name: "SCORED | 2.3.10.11 | POLICY | L1 Ensure Network access Restrict clients allowed to make remote calls to SAM is set to Administrators Remote Access Allow MS only"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: RestrictRemoteSAM
    data: "O:BAG:BAD:(A;;RC;;;BA)"
    type: string
  when: cis[2019]['2.3.10.11']
  tags:
    - memberserver
    - control_2.3.10.11

- name: "SCORED | 2.3.10.12 | POLICY | L1 Ensure Network access Shares that can be accessed anonymously is set to None"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: NullSessionShares
    data: ""
    type: multistring
  when: cis[2019]['2.3.10.12']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.12

- name: "SCORED | 2.3.10.13 | POLICY | L1 Ensure Network access Sharing and security model for local accounts is set to Classic - local users authenticate as themselves"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: ForceGuest
    data: 0
    type: dword
  when: cis[2019]['2.3.10.13']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.13

- name: "SCORED | 2.3.11.1 | POLICY | L1 Ensure Network security Allow Local System to use computer identity for NTLM is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: UseMachineId
    data: 1
    type: dword
  when: cis[2019]['2.3.11.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.1

- name: "SCORED | 2.3.11.2 | POLICY | L1 Ensure Network security Allow LocalSystem NULL session fallback is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa\Msv1_0
    name: allownullsessionfallback
    data: 0
    type: dword
  when: cis[2019]['2.3.11.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.2

- name: "SCORED | 2.3.11.3 | POLICY | L1 Ensure Network Security Allow PKU2U authentication requests to this computer to use online identities is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa\Pku2U
    name: AllowOnlineID
    data: 0
    type: dword
  when: cis[2019]['2.3.11.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.3

- name: "SCORED | 2.3.11.4 | POLICY | L1 Ensure Network security Configure encryption types allowed for Kerberos is set to AES128 HMAC SHA1 AES256 HMAC SHA1 Future encryption types"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System\Kerberos\Parameters
    name: SupportedEncryptionTypes
    data: 2147483640
    type: dword
  when: cis[2019]['2.3.11.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.4

- name: "SCORED | 2.3.11.5 | POLICY | L1 Ensure Network security Do not store LAN Manager hash value on next password change is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: NoLMHash
    data: 1
    type: dword
  when: cis[2019]['2.3.11.5']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.5

- name: "SCORED | 2.3.11.6 | POLICY | L1 Ensure Network security Force logoff when logon hours expire is set to Enabled"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
    name: EnableForcedLogOff
    data: 1
    type: dword
  when: cis[2019]['2.3.11.6']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.6

- name: "SCORED | 2.3.11.7 | POLICY | L1 Ensure Network security LAN Manager authentication level is set to Send NTLMv2 response only. Refuse LM  NTLM"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: LMCompatibilityLevel
    data: 5
    type: dword
  when: cis[2019]['2.3.11.7']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.7

- name: "SCORED | 2.3.11.8 | POLICY | L1 Ensure Network security LDAP client signing requirements is set to Negotiate signing or higher"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Ldap
    name: LDAPClientIntegrity
    data: 1
    type: dword
  when: cis[2019]['2.3.11.8']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.8

- name: "SCORED | 2.3.11.9 | POLICY | L1 Ensure Network security Minimum session security for NTLM SSP based including secure RPC clients is set to Require NTLMv2 session security Require 128-bit encryption"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa\Msv1_0
    name: NTLMMinClientSec
    data: 537395200
    type: dword
  when: cis[2019]['2.3.11.9']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.9

- name: "SCORED | 2.3.11.10 | POLICY | L1 Ensure Network security Minimum session security for NTLM SSP based including secure RPC servers is set to Require NTLMv2 session security Require 128-bit encryption"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa\Msv1_0
    name: NTLMMinServerSec
    data: 537395200
    type: dword
  when: cis[2019]['2.3.11.10']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.10

- name: "SCORED | 2.3.13.1 | POLICY | L1 Ensure Shutdown Allow system to be shut down without having to log on is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: ShutdownWithoutLogon
    data: 0
    type: dword
  when: cis[2019]['2.3.13.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.13.1

- name: "SCORED | 2.3.15.1 | POLICY | L1 Ensure System objects Require case insensitivity for non-Windows subsystems is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Session Manager\Kernel
    name: ObCaseInsensitive
    data: 1
    type: dword
  when: cis[2019]['2.3.15.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.15.1

- name: "SCORED | 2.3.15.2 | POLICY | L1 Ensure System objects Strengthen default permissions of internal system objects e.g. Symbolic Links is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Session Manager
    name: ProtectionMode
    data: 1
    type: dword
  when: cis[2019]['2.3.15.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.15.2

- name: "SCORED | 2.3.17.1 | POLICY | L1 Ensure User Account Control Admin Approval Mode for the Built-in Administrator account is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: FilterAdministratorToken
    data: 1
    type: dword
  when: cis[2019]['2.3.17.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.1

- name: "SCORED | 2.3.17.2 | POLICY | L1 Ensure User Account Control Behavior of the elevation prompt for administrators in Admin Approval Mode is set to Prompt for consent on the secure desktop"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: ConsentPromptBehaviorAdmin
    data: 2
    type: dword
  when: cis[2019]['2.3.17.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.2

- name: "SCORED | 2.3.17.3 | POLICY | L1 Ensure User Account Control Behavior of the elevation prompt for standard users is set to Automatically deny elevation requests"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: ConsentPromptBehaviorUser
    data: 0
    type: dword
  when: cis[2019]['2.3.17.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.3

- name: "SCORED | 2.3.17.4 | POLICY | L1 Ensure User Account Control Detect application installations and prompt for elevation is set to Enabled"
  win_regedit:
      path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
      name: EnableInstallerDetection
      data: 1
      type: dword
  when: cis[2019]['2.3.17.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.4

- name: "SCORED | 2.3.17.5 | POLICY | L1 Ensure User Account Control Only elevate UIAccess applications that are installed in secure locations is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: EnableSecureUIAPaths
    data: 1
    type: dword
  when: cis[2019]['2.3.17.5']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.5

- name: "SCORED | 2.3.17.6 | POLICY | L1 Ensure User Account Control Run all administrators in Admin Approval Mode is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: EnableLUA
    data: 1
    type: dword
  when: cis[2019]['2.3.17.6']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.6

- name: "SCORED | 2.3.17.7 | POLICY | L1 Ensure User Account Control Switch to the secure desktop when prompting for elevation is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: PromptOnSecureDesktop
    data: 1
    type: dword
  when: cis[2019]['2.3.17.7']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.7

- name: "SCORED | 2.3.17.8 | POLICY | L1 Ensure User Account Control Virtualize file and registry write failures to per-user locations is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: EnableVirtualization
    data: 1
    type: dword
  when: cis[2019]['2.3.17.8']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.8

# Section 9

- name: "SCORED | 9.1.1 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Firewall state' is set to 'On (recommended)'"
  win_firewall:
    state: enabled
    profile: Domain
  when: cis[2019]['9.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.1

- name: "SCORED | 9.1.2 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Inbound connections' is set to 'Block (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile
    name: DefaultInboundAction
    data: 1
    type: dword
  when: cis[2019]['9.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.2

- name: "SCORED | 9.1.3 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Outbound connections' is set to 'Allow (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile
    name: DefaultOutboundAction
    data: 0
    type: dword
  when: cis[2019]['9.1.3']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.3

- name: "SCORED | 9.1.4 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Settings: Display a notification' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile
    name: DisableNotifications
    data: 1
    type: dword
  when: cis[2019]['9.1.4']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.4

# title has slashes switched
- name: "SCORED | 9.1.5 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Logging: Name' is set to '%SystemRoot%/System32/logfiles/firewall/domainfw.log'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogFilePath
    data: '{{ domain_firewall_log_path }}'
    type: string
  when: cis[2019]['9.1.5']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.5

- name: "SCORED | 9.1.6 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Logging: Size limit (KB)' is set to '16,384 KB or greater'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogFileSize
    data: '{{ domain_firewall_log_size }}'
    type: dword
  when: cis[2019]['9.1.6']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.6

- name: "SCORED | 9.1.7 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Logging: Log dropped packets' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogDroppedPackets
    data: 1
    type: dword
  when: cis[2019]['9.1.7']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.7

- name: "SCORED | 9.1.8 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Logging: Log successful connections' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogSuccessfulConnections
    data: 1
    type: dword
  when: cis[2019]['9.1.8']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.7

- name: "SCORED | 9.2.1 | POLICY | (L1) Ensure 'Windows Firewall: Private: Firewall state' is set to 'On (recommended)'"
  win_firewall:
    state: enabled
    profile: Private
  when: cis[2019]['9.2.1']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.1

- name: "SCORED | 9.2.2 | POLICY | (L1) Ensure 'Windows Firewall: Private: Inbound connections' is set to 'Block (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile
    name: DefaultInboundAction
    data: 1
    type: dword
  when: cis[2019]['9.2.2']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.2

- name: "SCORED | 9.2.3 | POLICY | (L1) Ensure 'Windows Firewall: Private: Outbound connections' is set to 'Allow (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile
    name: DefaultOutboundAction
    data: 0
    type: dword
  when: cis[2019]['9.2.3']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.3

- name: "SCORED | 9.2.4 | POLICY | (L1) Ensure 'Windows Firewall: Private: Settings: Display a notification' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile
    name: DisableNotifications
    data: 1
    type: dword
  when: cis[2019]['9.2.4']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.4

# title has slashes switched
- name: "SCORED | 9.2.5 | POLICY | (L1) Ensure 'Windows Firewall: Private: Logging: Name' is set to '%SystemRoot%/System32/logfiles/firewall/privatefw.log'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging
    name: LogFilePath
    data: '{{ private_firewall_log_path }}'
    type: string
  when: cis[2019]['9.2.5']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.5

- name: "SCORED | 9.2.6 | POLICY | (L1) Ensure 'Windows Firewall: Private: Logging: Size limit (KB)' is set to '16,384 KB or greater'"
  win_regedit:
      path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging
      name: LogFileSize
      data: '{{ private_firewall_log_size }}'
      type: dword
  when: cis[2019]['9.2.6']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.6

- name: "SCORED | 9.2.7 | POLICY | (L1) Ensure 'Windows Firewall: Private: Logging: Log dropped packets' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging
    name: LogDroppedPackets
    data: 1
    type: dword
  when: cis[2019]['9.2.7']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.7

- name: "SCORED | 9.2.8 | POLICY | (L1) Ensure 'Windows Firewall: Private: Logging: Log successful connections' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging
    name: LogSuccessfulConnections
    data: 1
    type: dword
  when: cis[2019]['9.2.8']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.8

- name: "SCORED | 9.3.1 | POLICY | (L1) Ensure 'Windows Firewall: Public: Firewall state' is set to 'On (recommended)'"
  win_firewall:
    state: enabled
    profile: Public
  when: cis[2019]['9.3.1']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.1

- name: "SCORED | 9.3.2 | POLICY | (L1) Ensure 'Windows Firewall: Public: Inbound connections' is set to 'Block (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: DefaultInboundAction
    data: 1
    type: dword
  when: cis[2019]['9.3.2']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.2

- name: "SCORED | 9.3.3 | POLICY | (L1) Ensure 'Windows Firewall: Public: Outbound connections' is set to 'Allow (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: DefaultOutboundAction
    data: 0
    type: dword
  when: cis[2019]['9.3.3']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.3

- name: "SCORED | 9.3.4 | POLICY | (L1) Ensure 'Windows Firewall: Public: Settings: Display a notification' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: DisableNotifications
    data: 1
    type: dword
  when: cis[2019]['9.3.4']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.4

- name: "SCORED | 9.3.5 | POLICY | (L1) Ensure 'Windows Firewall: Public: Settings: Apply local firewall rules' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: AllowLocalPolicyMerge
    data: 0
    type: dword
  when:
    - cis[2019]['9.3.5']
    - not win_skip_for_test
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.5

- name: "SCORED | 9.3.6 | POLICY | (L1) Ensure 'Windows Firewall: Public: Settings: Apply local connection security rules' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: AllowLocalIPsecPolicyMerge
    data: 0
    type: dword
  when: cis[2019]['9.3.6']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.6

# title has slashes switched
- name: "SCORED | 9.3.7 | POLICY | (L1) Ensure 'Windows Firewall: Public: Logging: Name' is set to '%SystemRoot%/System32/logfiles/firewall/publicfw.log'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging
    name: LogFilePath
    data: '{{ public_firewall_log_path }}'
    type: string
  when: cis[2019]['9.3.7']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.7

- name: "SCORED | 9.3.8 | POLICY | (L1) Ensure 'Windows Firewall: Public: Logging: Size limit (KB)' is set to '16,384 KB or greater'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging
    name: LogFileSize
    data: '{{ public_firewall_log_size }}'
    type: dword
  when: cis[2019]['9.3.8']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.8

- name: "SCORED | 9.3.9 | POLICY | (L1) Ensure 'Windows Firewall: Public: Logging: Log dropped packets' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging
    name: LogDroppedPackets
    data: 1
    type: dword
  when: cis[2019]['9.3.9']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.9

- name: "SCORED | 9.3.10 | POLICY | (L1) Ensure 'Windows Firewall: Public: Logging: Log successful connections' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging
    name: LogSuccessfulConnections
    data: 1
    type: dword
  when: cis[2019]['9.3.10']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.10

# Section 17

- name: "SCORED | 17.1.1 | POLICY | L1 Ensure Audit Credential Validation is set to Success and Failure"
  block:
    - name: "SCORED | 17.1.1 | AUDIT | L1 Ensure Audit Credential Validation is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Credential Validation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_1_1_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.1.1 | POLICY | L1 Ensure Audit Credential Validation is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Credential Validation" /success:enable
      when: "'Success' not in rule_17_1_1_audit.stdout"
      changed_when: "'Success' not in rule_17_1_1_audit.stdout"

    - name: "SCORED | 17.1.1 | POLICY | L1 Ensure Audit Credential Validation is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Credential Validation" /failure:enable
      when: "'Failure' not in rule_17_1_1_audit.stdout"
      changed_when: "'Failure' not in rule_17_1_1_audit.stdout"
  when:
    - cis[2019]['17.1.1']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_17.1.1

- name: "SCORED | 17.1.2 | POLICY | L1 Ensure 'Audit Kerberos Authentication Service' is set to 'Success and Failure' DC Only"
  block:
    - name: "SCORED | 17.1.2 | AUDIT | L1 Ensure 'Audit Kerberos Authentication Service' is set to 'Success and Failure' DC Only"
      win_shell: AuditPol /get /subcategory:"Kerberos Authentication Service" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_1_2_audit

    - name: "SCORED | 17.1.2 | POLICY | L1 Ensure 'Audit Kerberos Authentication Service' is set to 'Success and Failure' DC Only"
      win_shell: AuditPol /set /subcategory:"Kerberos Authentication Service" /success:enable
      when: "'Success' not in rule_17_1_2_audit.stdout"

    - name: "SCORED | 17.1.2 | POLICY | L1 Ensure 'Audit Kerberos Authentication Service' is set to 'Success and Failure' DC Only"
      win_shell: AuditPol /set /subcategory:"Kerberos Authentication Service" /failure:enable
      when: "'Failure' not in rule_17_1_2_audit.stdout"
  when:
    - cis[2019]['17.1.2']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.1.2

- name: "SCORED | 17.1.3 | POLICY | L1 Ensure 'Audit Kerberos Service Ticket Operations' is set to 'Success and Failure'"
  block:
    - name: "SCORED | 17.1.3 | AUDIT | L1 Ensure 'Audit Kerberos Service Ticket Operations' is set to 'Success and Failure'"
      win_shell: AuditPol /get /subcategory:"Kerberos Service Ticket Operations" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_1_3_audit

    - name: "SCORED | 17.1.3 | POLICY | L1 Ensure 'Audit Kerberos Service Ticket Operations' is set to 'Success and Failure'"
      win_shell: AuditPol /set /subcategory:"Kerberos Service Ticket Operations" /success:enable
      when: "'Success' not in rule_17_1_3_audit.stdout"

    - name: "SCORED | 17.1.3 | POLICY | L1 Ensure 'Audit Kerberos Service Ticket Operations' is set to 'Success and Failure'"
      win_shell: AuditPol /set /subcategory:"Kerberos Service Ticket Operations" /failure:enable
      when: "'Failure' not in rule_17_1_3_audit.stdout"
  when:
    - cis[2019]['17.1.3']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.1.3

- name: "SCORED | 17.2.1 | POLICY | L1 Ensure Audit Application Group Management is set to Success and Failure"
  block:
    - name: "SCORED | 17.2.1 | AUDIT | L1 Ensure Audit Application Group Management is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Security Group Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_1_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.1 | POLICY | L1 Ensure Audit Application Group Management is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Security Group Management" /success:enable
      when: "'Success' not in rule_17_2_1_audit.stdout"

    - name: "SCORED | 17.2.1 | POLICY | L1 Ensure Audit Application Group Management is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Security Group Management" /failure:enable
      when: "'Failure' not in rule_17_2_1_audit.stdout"
  when:
    - cis[2019]['17.2.1']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_17.2.1

- name: "SCORED | 17.2.2 | POLICY | L1 Ensure Audit Computer Account Management is set to include Success DC only"
  block:
    - name: "SCORED | 17.2.2 | AUDIT | L1 Ensure Audit Computer Account Management is set to include Success DC only"
      win_shell: AuditPol /get /subcategory:"Computer Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_2_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.2 | POLICY | L1 Ensure Audit Computer Account Management is set to include Success DC only"
      win_shell: AuditPol /set /subcategory:"Computer Account Management" /success:enable
      changed_when: "'Success' not in rule_17_2_2_audit.stdout"
      when: "'Success' not in rule_17_2_2_audit.stdout"
  when:
    - cis[2019]['17.2.2']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.2.2

- name: "SCORED | 17.2.3 | POLICY | L1 Ensure Audit Distribution Group Management is set to include Success DC only"
  block:
    - name: "SCORED | 17.2.3 | AUDIT | L1 Ensure Audit Distribution Group Management is set to include Success DC only"
      win_shell: AuditPol /get /subcategory:"Distribution Group Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_3_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.3 | POLICY | L1 Ensure Audit Distribution Group Management is set to include Success DC only"
      win_shell: AuditPol /set /subcategory:"Distribution Group Management" /success:enable
      when: "'Success' not in rule_17_2_3_audit.stdout"
  when:
    - cis[2019]['17.2.3']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.2.3

- name: "SCORED | 17.2.4 | POLICY | L1 Ensure Audit Other Account Management Events is set to include Success DC only"
  block:
    - name: "SCORED | 17.2.4 | AUDIT | L1 Ensure Audit Other Account Management Events is set to include Success DC only"
      win_shell: AuditPol /get /subcategory:"Other Account Management Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_4_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.4 | POLICY | L1 Ensure Audit Other Account Management Events is set to include Success DC only"
      win_shell: AuditPol /set /subcategory:"Other Account Management Events" /success:enable
      when: "'Success' not in rule_17_2_4_audit.stdout"
  when:
    - cis[2019]['17.2.4']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.2.4

- name: "SCORED | 17.2.5 | AUDIT | L1 Ensure Audit Security Group Management is set to include Success"
  block:
    - name: "SCORED | 17.2.5 | AUDIT | L1 Ensure Audit Security Group Management is set to include Success"
      win_shell: AuditPol /get /subcategory:"Security Group Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_5_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.5 | POLICY | L1 Ensure Audit Security Group Management is set to include Success"
      win_shell: AuditPol /set /subcategory:"Security Group Management" /success:enable
      when: "'Success' not in rule_17_2_5_audit.stdout"
  when: cis[2019]['17.2.5']
  tags:
    - domaincontroller
    - memberserver
    - control_17.2.5

- name: "SCORED | 17.2.6 | POLICY | L1 Ensure Audit User Account Management is set to Success and Failure"
  block:
    - name: "SCORED | 17.2.6 | AUDIT | L1 Ensure Audit User Account Management is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"User Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_2_6_audit

    - name: "SCORED | 17.2.6 | POLICY | L1 Ensure Audit User Account Management is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"User Account Management" /success:enable
      when: "'Success' not in rule_17_2_6_audit.stdout"

    - name: "SCORED | 17.2.6 | POLICY | L1 Ensure Audit User Account Management is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"User Account Management" /failure:enable
      when: "'Failure' not in rule_17_2_6_audit.stdout"
  when: cis[2019]['17.2.6']
  tags:
      - domaincontroller
      - memberserver
      - control_17.2.6

- name: "SCORED | 17.3.1 | POLICY | L1 Ensure Audit PNP Activity is set to include Success"
  block:
    - name: "SCORED | 17.3.1 | AUDIT | L1 Ensure Audit PNP Activity is set to include Success"
      win_shell: AuditPol /get /subcategory:"Plug and Play Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_3_1_audit

    - name: "SCORED | 17.3.1 | POLICY | L1 Ensure Audit PNP Activity is set to include Success"
      win_shell: AuditPol /set /subcategory:"Plug and Play Events" /success:enable
      when: "'Success' not in rule_17_3_1_audit.stdout"
  when: cis[2019]['17.3.1']
  tags:
      - domaincontroller
      - memberserver
      - control_17.3.1

- name: "SCORED | 17.3.2 | POLICY | L1 Ensure Audit Process Creation is set to include Success"
  block:
    - name: "SCORED | 17.3.2 | AUDIT | L1 Ensure Audit Process Creation is set to include Success"
      win_shell: AuditPol /get /subcategory:"Process Creation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_3_2_audit

    - name: "SCORED | 17.3.2 | POLICY | L1 Ensure Audit Process Creation is set to include Success"
      win_shell: AuditPol /set /subcategory:"Process Creation" /success:enable
      when: "'Success' not in rule_17_3_2_audit.stdout"
  when: cis[2019]['17.3.2']
  tags:
    - domaincontroller
    - memberserver
    - control_17.3.2

- name: "SCORED | 17.4.1 | POLICY | L1 Ensure Audit Directory Service Access is set to include Failure DC only"
  block:
    - name: "SCORED | 17.4.1 | AUDIT | L1 Ensure Audit Directory Service Access is set to include Failure DC only"
      win_shell: AuditPol /get /subcategory:"Directory Service Access" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_4_1_audit

    - name: "SCORED | 17.4.1 | POLICY | L1 Ensure Audit Directory Service Access is set to include Failure DC only"
      win_shell: AuditPol /set /subcategory:"Directory Service Access" /success:enable
      when: "'Success' not in rule_17_4_1_audit.stdout"
  when:
    - cis[2019]['17.4.1']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.4.1

- name: "SCORED | 17.4.2 | POLICY | L1 Ensure Audit Directory Service Changes is set to include Success DC only"
  block:
    - name: "SCORED | 17.4.2 | AUDIT | L1 Ensure Audit Directory Service Changes is set to include Success DC only"
      win_shell: AuditPol /get /subcategory:"Directory Service Changes" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_4_2_audit

    - name: "SCORED | 17.4.2 | POLICY | L1 Ensure Audit Directory Service Changes is set to include Success DC only"
      win_shell: AuditPol /set /subcategory:"Directory Service Changes" /success:enable
      when: "'Success' not in rule_17_4_2_audit.stdout"
  when:
    - cis[2019]['17.4.2']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - domaincontroller
      - control_17.4.2

- name: "SCORED | 17.5.1 | POLICY | L1 Ensure Audit Account Lockout is set to include Failure"
  block:
    - name: "SCORED | 17.5.1 | AUDIT | L1 Ensure Audit Account Lockout is set to include Failure"
      win_shell: AuditPol /get /subcategory:"Account Lockout" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_1_audit

    - name: "SCORED | 17.5.1 | POLICY | L1 Ensure Audit Account Lockout is set to include Failure"
      win_shell: AuditPol /set /subcategory:"Account Lockout" /failure:enable
      when: "'Failure' not in rule_17_5_1_audit.stdout"
  when: cis[2019]['17.5.1']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.1

- name: "SCORED | 17.5.2 | POLICY | L1 Ensure Audit Group Membership is set to include Success"
  block:
    - name: "SCORED | 17.5.2 | AUDIT | L1 Ensure Audit Group Membership is set to include Success"
      win_shell: AuditPol /get /subcategory:"Group Membership" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_2_audit

    - name: "SCORED | 17.5.2 | POLICY | L1 Ensure Audit Group Membership is set to include Success"
      win_shell: AuditPol /set /subcategory:"Group Membership" /success:enable
      when: "'Success' not in rule_17_5_2_audit.stdout"
  when: cis[2019]['17.5.2']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.2

- name: "SCORED | 17.5.3 | AUDIT | L1 Ensure Audit Logoff is set to include Success"
  block:
    - name: "SCORED | 17.5.3 | AUDIT | L1 Ensure Audit Logoff is set to include Success"
      win_shell: AuditPol /get /subcategory:"Logoff" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_3_audit

    - name: "SCORED | 17.5.3 | POLICY | L1 Ensure Audit Logoff is set to include Success"
      win_shell: AuditPol /set /subcategory:"Logoff" /success:enable
      when: "'Success' not in rule_17_5_3_audit.stdout"
  when: cis[2019]['17.5.3']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.3

- name: "SCORED | 17.5.4 | POLICY | L1 Ensure Audit Logon is set to Success and Failure"
  block:
    - name: "SCORED | 17.5.4 | AUDIT | L1 Ensure Audit Logon is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_4_audit

    - name: "SCORED | 17.5.4 | POLICY | L1 Ensure Audit Logon is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Logon" /success:enable
      when: "'Failure' not in rule_17_5_4_audit.stdout"

    - name: "SCORED | 17.5.4 | POLICY | L1 Ensure Audit Logon is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Logon" /failure:enable
      when: "'Failure' not in rule_17_5_4_audit.stdout"
  when: cis[2019]['17.5.4']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.4

- name: "SCORED | 17.5.5 | POLICY | L1 Ensure Audit Other LogonLogoff Events is set to Success and Failure"
  block:
    - name: "SCORED | 17.5.5 | AUDIT | L1 Ensure Audit Other LogonLogoff Events is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Other Logon/Logoff Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_5_audit

    - name: "SCORED | 17.5.5 | POLICY | L1 Ensure Audit Other LogonLogoff Events is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Other Logon/Logoff Events" /success:enable
      when: "'Success' not in rule_17_5_5_audit.stdout"

    - name: "SCORED | 17.5.5 | POLICY | L1 Ensure Audit Other LogonLogoff Events is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Other Logon/Logoff Events" /failure:enable
      when: "'Failure' not in rule_17_5_5_audit.stdout"
  when: cis[2019]['17.5.5']
  tags:
    - domaincontroller
    - memberserver
    - control_17.5.5  

- name: "SCORED | 17.5.6 | POLICY | L1 Ensure Audit Special Logon is set to include Success"
  block:
    - name: "SCORED | 17.5.6 | AUDIT | L1 Ensure Audit Special Logon is set to include Success"
      win_shell: AuditPol /get /subcategory:"Special Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_6_audit

    - name: "SCORED | 17.5.6 | POLICY | L1 Ensure Audit Special Logon is set to include Success"
      win_shell: AuditPol /set /subcategory:"Special Logon" /success:enable
      when: "'Success' not in rule_17_5_6_audit.stdout"
  when: cis[2019]['17.5.6']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.6

- name: "SCORED | 17.6.1 | POLICY | L1 Ensure Audit Detailed File Share is set to include Failure"
  block:
    - name: "SCORED | 17.6.1 | AUDIT | L1 Ensure Audit Detailed File Share is set to include Failure"
      win_shell: AuditPol /get /subcategory:"Detailed File Share" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_6_1_audit

    - name: "SCORED | 17.6.1 | POLICY | L1 Ensure Audit Detailed File Share is set to include Failure"
      win_shell: AuditPol /set /subcategory:"Detailed File Share" /failure:enable
      when: "'Failure' not in rule_17_6_1_audit.stdout"
  when: cis[2019]['17.6.1']
  tags:
    - domaincontroller
    - memberserver
    - control_17.6.1

- name: "SCORED | 17.6.2 | POLICY | L1 Ensure Audit File Share is set to Success and Failure"
  block:
    - name: "SCORED | 17.6.2 | AUDIT | L1 Ensure Audit File Share is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"File Share" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_6_2_audit

    - name: "SCORED | 17.6.2 | POLICY | L1 Ensure Audit File Share is set to Success and Failure"
      win_shell: AuditPol /set /subcategory:"File Share" /failure:enable
      when: "'Failure' not in rule_17_6_2_audit.stdout"
  when: cis[2019]['17.6.2']
  tags:
    - domaincontroller
    - memberserver
    - control_17.6.2

- name: "SCORED | 17.6.3 | POLICY | L1 Ensure Audit Other Object Access Events is set to Success and Failure"
  win_audit_policy_system:
    subcategory: Other Object Access Events
    audit_type: success, failure
  when: cis[2019]['17.6.3']
  tags:
    - domaincontroller
    - memberserver
    - control_17.6.3

- name: "SCORED | 17.6.4 | POLICY | L1 Ensure Audit Removable Storage is set to Success and Failure"
  block:
    - name: "SCORED | 17.6.4 | AUDIT | L1 Ensure Audit Removable Storage is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Removable Storage" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_6_4_audit

    - name: "SCORED | 17.6.4 | POLICY | L1 Ensure Audit Removable Storage is set to Success and Failure"
      win_shell: AuditPol /set /subcategory:"Removable Storage" /success:enable
      when: "'Success' not in rule_17_6_4_audit.stdout"
  when: cis[2019]['17.6.4']
  tags:
    - domaincontroller
    - memberserver
    - control_17.6.4

- name: "SCORED | 17.7.1 | POLICY | L1 Ensure Audit Audit Policy Change is set to include Success"
  block:
    - name: "SCORED | 17.7.1 | AUDIT | L1 Ensure Audit Audit Policy Change is set to include Success"
      win_shell: AuditPol /get /subcategory:"Audit Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_1_audit

    - name: "SCORED | 17.7.1 | POLICY | L1 Ensure Audit Audit Policy Change is set to include Success"
      win_shell: AuditPol /set /subcategory:"Audit Policy Change" /success:enable
      when: "'Success' not in rule_17_7_1_audit.stdout"
  when: cis[2019]['17.7.1']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.1

- name: "SCORED | 17.7.2 | POLICY | L1 Ensure Audit Authentication Policy Change is set to include Success"
  block:
    - name: "SCORED | 17.7.2 | AUDIT | L1 Ensure Audit Authentication Policy Change is set to include Success"
      win_shell: AuditPol /get /subcategory:"Authentication Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_2_audit

    - name: "SCORED | 17.7.2 | POLICY | L1 Ensure Audit Authentication Policy Change is set to include Success"
      win_shell: AuditPol /set /subcategory:"Authentication Policy Change" /success:enable
      when: "'Success' not in rule_17_7_2_audit.stdout"
  when: cis[2019]['17.7.2']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.2

- name: "SCORED | 17.7.3 | POLICY | L1 Ensure Audit Authorization Policy Change is set to include Success"
  block:
    - name: "SCORED | 17.7.3 | AUDIT | L1 Ensure Audit Authorization Policy Change is set to include Success"
      win_shell: AuditPol /get /subcategory:"Authorization Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_3_audit

    - name: "SCORED | 17.7.3 | POLICY | L1 Ensure Audit Authorization Policy Change is set to include Success"
      win_shell: AuditPol /set /subcategory:"Authorization Policy Change" /success:enable
      when: "'Success' not in rule_17_7_3_audit.stdout"
  when: cis[2019]['17.7.3']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.3

- name: "SCORED | 17.7.4 | POLICY | L1 Ensure Audit MPSSVC Rule-Level Policy Change is set to Success and Failure"
  block:
    - name: "SCORED | 17.7.4 | AUDIT | L1 Ensure Audit MPSSVC Rule-Level Policy Change is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"MPSSVC Rule-Level Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_4_audit

    - name: "SCORED | 17.7.4 | POLICY | L1 Ensure Audit MPSSVC Rule-Level Policy Change is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"MPSSVC Rule-Level Policy Change" /success:enable
      when: "'Success' not in rule_17_7_4_audit.stdout"

    - name: "SCORED | 17.7.4 | POLICY | L1 Ensure Audit MPSSVC Rule-Level Policy Change is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"MPSSVC Rule-Level Policy Change" /failure:enable
      when: "'Failure' not in rule_17_7_4_audit.stdout"
  when: cis[2019]['17.7.4']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.4
  

- name: "SCORED | 17.7.5 | POLICY | L1 Ensure Audit Other Policy Change Events is set to include Failure"
  block:
    - name: "SCORED | 17.7.5 | AUDIT | L1 Ensure Audit Other Policy Change Events is set to include Failure"
      win_shell: AuditPol /get /subcategory:"Other Policy Change Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_5_audit

    - name: "SCORED | 17.7.5 | POLICY | L1 Ensure Audit Other Policy Change Events is set to include Failure"
      win_shell: AuditPol /set /subcategory:"Other Policy Change Events" /success:enable
      when: "'Success' not in rule_17_7_5_audit.stdout"
  when: cis[2019]['17.7.5']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.5

- name: "SCORED | 17.8.1 | POLICY | L1 Ensure Audit Sensitive Privilege Use is set to Success and Failure"
  block:
    - name: "SCORED | 17.8.1 | AUDIT | L1 Ensure Audit Sensitive Privilege Use is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_8_1_audit

    - name: "SCORED | 17.8.1 | POLICY | L1 Ensure Audit Sensitive Privilege Use is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /success:enable
      when: "'Success' not in rule_17_8_1_audit.stdout"

    - name: "SCORED | 17.8.1 | POLICY | L1 Ensure Audit Sensitive Privilege Use is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /failure:enable
      when: "'Failure' not in rule_17_8_1_audit.stdout"
  when: cis[2019]['17.8.1']
  tags:
    - domaincontroller
    - memberserver
    - control_17.8.1

- name: "SCORED | 17.9.1 | POLICY | L1 Ensure Audit IPsec Driver is set to Success and Failure"
  block:
    - name: "SCORED | 17.9.1 | AUDIT | L1 Ensure Audit IPsec Driver is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"IPsec Driver" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_1_audit

    - name: "SCORED | 17.9.1 | POLICY | L1 Ensure Audit IPsec Driver is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"IPsec Driver" /success:enable
      when: "'Success' not in rule_17_9_1_audit.stdout"

    - name: "SCORED | 17.9.1 | POLICY | L1 Ensure Audit IPsec Driver is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"IPsec Driver" /failure:enable
      when: "'Failure' not in rule_17_9_1_audit.stdout"
  when: cis[2019]['17.9.1']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.1

- name: "SCORED | 17.9.2 | POLICY | L1 Ensure Audit Other System Events is set to Success and Failure"
  block:
    - name: "SCORED | 17.9.2 | AUDIT | L1 Ensure Audit Other System Events is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Other System Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_2_audit

    - name: "SCORED | 17.9.2 | POLICY | L1 Ensure Audit Other System Events is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Other System Events" /success:enable
      when: "'Success' not in rule_17_9_2_audit.stdout"

    - name: "SCORED | 17.9.2 | POLICY | L1 Ensure Audit Other System Events is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Other System Events" /failure:enable
      when: "'Failure' not in rule_17_9_2_audit.stdout"
  when: cis[2019]['17.9.2']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.2

- name: "SCORED | 17.9.3 | POLICY | L1 Ensure Audit Security State Change is set to include Success"
  block:
    - name: "SCORED | 17.9.3 | AUDIT | L1 Ensure Audit Security State Change is set to include Success"
      win_shell: AuditPol /get /subcategory:"Security State Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_3_audit

    - name: "SCORED | 17.9.3 | POLICY | L1 Ensure Audit Security State Change is set to include Success"
      win_shell: AuditPol /set /subcategory:"Security State Change" /success:enable
      when: "'Success' not in rule_17_9_3_audit.stdout"
  when: cis[2019]['17.9.3']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.3

- name: "SCORED | 17.9.4 | POLICY | L1 Ensure Audit Security System Extension is set to include Success"
  block:
    - name: "SCORED | 17.9.4 | AUDIT | L1 Ensure Audit Security System Extension is set to include Success"
      win_shell: AuditPol /get /subcategory:"Security System Extension" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_4_audit

    - name: "SCORED | 17.9.4 | POLICY | L1 Ensure Audit Security System Extension is set to include Success"
      win_shell: AuditPol /set /subcategory:"Security System Extension" /success:enable
      when: "'Success' not in rule_17_9_4_audit.stdout"
  when: cis[2019]['17.9.4']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.4

- name: "SCORED | 17.9.5 | POLICY | L1 Ensure Audit System Integrity is set to Success and Failure"
  block:
    - name: "SCORED | 17.9.5 | AUDIT | L1 Ensure Audit System Integrity is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"System Integrity" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_5_audit

    - name: "SCORED | 17.9.5 | POLICY | L1 Ensure Audit System Integrity is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"System Integrity" /success:enable
      changed_when: "'Success' not in rule_17_9_5_audit.stdout"
      when: "'Success' not in rule_17_9_5_audit.stdout"

    - name: "SCORED | 17.9.5 | POLICY | L1 Ensure Audit System Integrity is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"System Integrity" /failure:enable
      changed_when: "'Failure' not in rule_17_9_5_audit.stdout"
      when: "'Failure' not in rule_17_9_5_audit.stdout"
  when: cis[2019]['17.9.5']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.5
  
  # Section 18

