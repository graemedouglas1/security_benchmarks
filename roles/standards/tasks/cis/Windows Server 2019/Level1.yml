---

- name: 1.1.1 | Ensure Enforce password history is set to 24 or more passwords
  win_security_policy:
    section: System Access
    key: PasswordHistorySize
    value: "{{ item.1.passwordhistorysize }}"
  when:
    - "{{ item.0.reference }}"
    - "{{ item.1.enabled }}"
  #tags:
  #  - "{{ item.1.tags }}"
  with_subelements:
    - "{{ r2019 }}"
    - properties

# Section 1

- name: "SCORED | 1.1.1 | POLICY | L1 Ensure Enforce password history is set to 24 or more passwords"
  win_security_policy:
    section: System Access
    key: PasswordHistorySize
    value: "{{ passwordhistorysize }}"
  when: cis[2019]['1.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.1

- name: "SCORED | 1.1.2 | POLICY | L1 Ensure Maximum password age is set to 60 or fewer days but not 0"
  win_security_policy:
    section: System Access
    key: MaximumPasswordAge
    value: "{{ maximumpasswordage }}"
  when: cis[2019]['1.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.2

- name: "SCORED | 1.1.3 | POLICY | L1 Ensure Minimum password age is set to 1 or more days"
  win_security_policy:
    section: System Access
    key: MinimumPasswordAge
    value: "{{ minimumpasswordage }}"
  when: cis[2019]['1.1.3']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.3

- name: "SCORED | 1.1.4 | POLICY | L1 Ensure Minimum password length is set to 14 or more characters"
  win_security_policy:
    section: System Access
    key: MinimumPasswordLength
    value: "{{ minimumpasswordlength }}"
  when: cis[2019]['1.1.4']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.4

- name: "SCORED | 1.1.5 | POLICY | L1 Ensure Password must meet complexity requirements is set to Enabled"
  win_security_policy:
    section: System Access
    key: PasswordComplexity
    value: "{{ passwordcomplexity }}"
  when: cis[2019]['1.1.5']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.5

- name: "SCORED | 1.1.6 | POLICY | L1 Ensure Store passwords using reversible encryption is set to Disabled"
  win_security_policy:
    section: System Access
    key: ClearTextPassword
    value: "{{ cleartextpassword }}"
  when: cis[2019]['1.1.6']
  tags:
    - domaincontroller
    - memberserver
    - control_1.1.6

- name: "SCORED | 1.2.1 | POLICY | L1 Ensure Account lockout duration is set to 15 or more minutes"
  win_security_policy:
    section: System Access
    key: LockoutDuration
    value: "{{ lockoutduration }}"
  when:
    - cis[2019]['1.2.1']
    - is_implemented
  tags:
    - domaincontroller
    - memberserver
    - control_1.2.1

# This rule must be applied first to make control_1.2.1 and control_1.2.3 applicable
- name: "SCORED | 1.2.2 | POLICY | L1 Ensure Account lockout threshold is set to 10 or fewer invalid logon attempts but not 0"
  win_security_policy:
    section: System Access
    key: LockoutBadCount
    value: "{{ lockoutbadcount }}"
  when: cis[2019]['1.2.2']
  tags:
    - domaincontroller
    - memberserver
    - control_1.2.2

- name: "SCORED | 1.2.3 | POLICY | L1 Ensure Reset account lockout counter after is set to 15 or more minutes"
  win_security_policy:
    section: System Access
    key: ResetLockoutCount
    value: "{{ resetlockoutcount }}"
  when: cis[2019]['1.2.3']
  tags:
    - domaincontroller
    - memberserver
    - control_1.2.3

# Section 2

- name: "SCORED | 2.2.1 | POLICY | L1 Ensure Access Credential Manager as a trusted caller is set to No One"
  win_user_right:
    name: SeTrustedCredManAccessPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.1

- name: "SCORED | 2.2.2 & 2.2.3 | POLICY | L1 Ensure Access this computer from the network is set to Administrators Authenticated Users ENTERPRISE DOMAIN CONTROLLERS DC only"
  win_user_right:
    name: SeNetworkLogonRight
    users:
      - Administrators
      - Authenticated Users
    action: set
  when:
    - cis[2019]['2.2.2'] or cis[2019]['2.2.3']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.2
    - control_2.2.3

- name: "SCORED | 2.2.4 | POLICY | L1 Ensure Act as part of the operating system is set to No One"
  win_user_right:
    name: SeTcbPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.4

- name: "SCORED | 2.2.5 | POLICY | L1 Ensure Add workstations to domain is set to Administrators DC only"
  win_user_right:
    name: SeMachineAccountPrivilege
    users: Administrators
    action: set
  when:
    - cis[2019]['2.2.5']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.5

- name: "SCORED | 2.2.6 | POLICY | L1 Ensure Adjust memory quotas for a process is set to Administrators LOCAL SERVICE NETWORK SERVICE"
  win_user_right:
    name: SeIncreaseQuotaPrivilege
    users:
      - Administrators
      - Local Service
      - Network Service
    action: set
  when: cis[2019]['2.2.6']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.6

- name: "SCORED | 2.2.7 | POLICY | L1 Ensure Allow log on locally is set to Administrators"
  win_user_right:
    name: SeInteractiveLogonRight
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.7']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.7

- name: "SCORED | 2.2.8 & 2.2.9 | POLICY | L1 Ensure Allow log on through Remote Desktop Services is set to Administrators DC only"
  win_user_right:
    name: SeRemoteInteractiveLogonRight
    users:
      - Administrators
      - Remote Desktop Users
    action: set
  when:
    - ansible_windows_domain_role == "Primary domain controller"
    - cis[2019]['2.2.8'] or cis[2019]['2.2.9']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.8
    - control_2.2.9

- name: "SCORED | 2.2.10 | POLICY | L1 Ensure Back up files and directories is set to Administrators"
  win_user_right:
    name: SeBackupPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.10']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.10

- name: "SCORED | 2.2.11 | POLICY | L1 Ensure Change the system time is set to Administrators LOCAL SERVICE"
  win_user_right:
    name: SeSystemTimePrivilege
    users:
      - Administrators
      - Local Service
    action: set
  when: cis[2019]['2.2.11']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.11

- name: "SCORED | 2.2.12 | POLICY | L1 Ensure Change the time zone is set to Administrators LOCAL SERVICE"
  win_user_right:
    name: SeTimeZonePrivilege
    users:
      - Administrators
      - Local Service
    action: set
  when: cis[2019]['2.2.12']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.12

- name: "SCORED | 2.2.13 | POLICY | L1 Ensure Create a pagefile is set to Administrators"
  win_user_right:
    name: SeCreatePagefilePrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.13']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.13

- name: "SCORED | 2.2.14 | POLICY | L1 Ensure Create a token object is set to No One"
  win_user_right:
    name: SeCreateTokenPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.14']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.14

- name: "SCORED | 2.2.15 | POLICY | L1 Ensure Create global objects is set to Administrators LOCAL SERVICE NETWORK SERVICE SERVICE"
  win_user_right:
    name: SeCreateGlobalPrivilege
    users:
      - Administrators
      - Local Service
      - Network Service
      - Service
    action: set
  when: cis[2019]['2.2.15']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.15

- name: "SCORED | 2.2.16 | POLICY | L1 Ensure Create permanent shared objects is set to No One"
  win_user_right:
    name: SeCreatePermanentPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.16']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.16

- name: "SCORED | 2.2.17 | POLICY | L1 Ensure Create symbolic links is set to Administrators DC only"
  win_user_right:
    name: SeCreateSymbolicLinkPrivilege
    users:
      - Administrators
    action: set
  when:
    - cis[2019]['2.2.17']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.17

- name: "SCORED | 2.2.18 | POLICY | L1 Ensure Create symbolic links is set to Administrators NT VIRTUAL MACHINEVirtual Machines MS only"
  win_user_right:
    name: SeCreateSymbolicLinkPrivilege
    users:
      - Administrators
      - NT VIRTUAL MACHINE\Virtual Machines
    action: set
  when:
    - is_hyperv_installed
    - cis[2019]['2.2.18']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - memberserver
    - control_2.2.18

- name: "SCORED | 2.2.19 | POLICY | L1 Ensure Debug programs is set to Administrators"
  win_user_right:
    name: SeDebugPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.19']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.19

# Limiting hardening to only include the Guests group, since Local Account access will still be needed for non-domain-joined nodes
- name: "SCORED | 2.2.20 | POLICY | L1 Ensure Deny access to this computer from the network to include Guests DC only"
  win_user_right:
    name: SeDenyNetworkLogonRight
    users:
      - Guests
    action: set
  when:
    - cis[2019]['2.2.20']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.20

- name: "SCORED | 2.2.21 | POLICY | L1 Ensure Deny access to this computer from the network to include Guests Local account and member of Administrators group MS only"
  win_user_right:
    name: SeDenyNetworkLogonRight
    users:
      - Guests
      #- Local Account
      #- Administrators
    action: set
  when:
    - cis[2019]['2.2.21']
    - ansible_windows_domain_member
  tags:
    - memberserver
    - control_2.2.21

- name: "SCORED | 2.2.22 | POLICY | L1 Ensure Deny log on as a batch job to include Guests"
  win_user_right:
    name: SeDenyBatchLogonRight
    users:
      - Guests
    action: set
  when: cis[2019]['2.2.22']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.22

- name: "SCORED | 2.2.23 | POLICY | L1 Ensure Deny log on as a service to include Guests"
  win_user_right:
    name: SeDenyServiceLogonRight
    users:
      - Guests
    action: set
  when: cis[2019]['2.2.23']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.23

- name: "SCORED | 2.2.24 | POLICY | L1 Ensure Deny log on locally to include Guests"
  win_user_right:
    name: SeDenyInteractiveLogonRight
    users:
      - Guests
    action: set
  when: cis[2019]['2.2.24']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.24

- name: "SCORED | 2.2.25 | POLICY | L1 Ensure Deny log on through Remote Desktop Services to include Guests DC only"
  win_user_right:
    name: SeDenyRemoteInteractiveLogonRight
    users:
      - Guests
      #- Local Account
    action: set
  when: 
    - cis[2019]['2.2.25']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.25

- name: "SCORED | 2.2.26 | POLICY | L1 Ensure Deny log on through Remote Desktop Services is set to Guests Local account MS only"
  win_user_right:
    name: SeDenyRemoteInteractiveLogonRight
    users:
      - Guests
      #- Local Account
    action: set
  when: 
    - cis[2019]['2.2.26']
    - ansible_windows_domain_member
  tags:
    - memberserver
    - control_2.2.26

- name: "SCORED | 2.2.27 | POLICY | L1 Ensure Enable computer and user accounts to be trusted for delegation is set to Administrators DC only"
  win_user_right:
    name: SeEnableDelegationPrivilege
    users: Administrators
    action: set
  when:
    - cis[2019]['2.2.27']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.27

- name: "SCORED | 2.2.28 | POLICY | L1 Ensure Enable computer and user accounts to be trusted for delegation is set to No One MS only"
  win_user_right:
    name: SeEnableDelegationPrivilege
    users: []
    action: set
  when:
    - cis[2019]['2.2.28']
    - ansible_windows_domain_member
  tags:
    - memberserver
    - control_2.2.28

- name: "SCORED | 2.2.29 | POLICY | L1 Ensure Force shutdown from a remote system is set to Administrators"
  win_user_right:
    name: SeRemoteShutdownPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.29']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.29

- name: "SCORED | 2.2.30 | POLICY | L1 Ensure Generate security audits is set to LOCAL SERVICE NETWORK SERVICE"
  win_user_right:
    name: SeAuditPrivilege
    users:
      - Local Service
      - Network Service
    action: set
  when: cis[2019]['2.2.30']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.30

- name: "SCORED | 2.2.31 | POLICY | L1 Ensure Impersonate a client after authentication is set to Administrators LOCAL SERVICE NETWORK SERVICE SERVICE DC only"
  win_user_right:
    name: SeImpersonatePrivilege
    users:
      - Administrators
      - Local Service
      - Network Service
      - Service
    action: set
  when:
    - cis[2019]['2.2.31']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.31

- name: "SCORED | 2.2.32 | POLICY | L1 Ensure Impersonate a client after authentication is set to Administrators LOCAL SERVICE NETWORK SERVICE SERVICE and when the Web Server IIS Role with Web Services Role Service is installed IIS IUSRS MS only"
  win_user_right:
    name: SeImpersonatePrivilege
    users:
      - Administrators
      - IIS_IUSRS
      - Local Service
      - Network Service
      - Service
    action: set
  when:
    - cis[2019]['2.2.32']
    - ansible_windows_domain_member
  tags:
    - memberserver
    - control_2.2.32

- name: "SCORED | 2.2.33 | POLICY | L1 Ensure Increase scheduling priority is set to Administrators Window ManagerWindow Manager Group"
  win_user_right:
    name: SeIncreaseBasePriorityPrivilege
    users:
      - Administrators
      - Window Manager\Window Manager Group
    action: set
  when: cis[2019]['2.2.33']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.33

- name: "SCORED | 2.2.34 | POLICY | L1 Ensure Load and unload device drivers is set to Administrators"
  win_user_right:
    name: SeLoadDriverPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.34']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.34

- name: "SCORED | 2.2.35 | POLICY | L1 Ensure Lock pages in memory is set to No One"
  win_user_right:
    name: SeLockMemoryPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.35']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.35

- name: "SCORED | 2.2.37 & 2.2.38 | POLICY | L1 Ensure Manage auditing and security log is set to Administrators and when Exchange is running in the environment Exchange Servers DC only"
  win_user_right:
    name: SeSecurityPrivilege
    users:
      - Administrators
    action: set
  when:
    - cis[2019]['2.2.37'] or cis[2019]['2.2.38']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.37
    - control_2.2.38

- name: "SCORED | 2.2.39 | POLICY | L1 Ensure Modify an object label is set to No One"
  win_user_right:
    name: SeReLabelPrivilege
    users: []
    action: set
  when: cis[2019]['2.2.39']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.39

- name: "SCORED | 2.2.40 | POLICY | L1 Ensure Modify firmware environment values is set to Administrators"
  win_user_right:
    name: SeSystemEnvironmentPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.40']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.40

- name: "SCORED | 2.2.41 | POLICY | L1 Ensure Perform volume maintenance tasks is set to Administrators"
  win_user_right:
    name: SeManageVolumePrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.41']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.41

- name: "SCORED | 2.2.42 | POLICY | L1 Ensure Profile single process is set to Administrators"
  win_user_right:
    name: SeProfileSingleProcessPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.42']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.42

- name: "SCORED | 2.2.43 | POLICY | L1 Ensure Profile system performance is set to Administrators NT SERVICEWdiServiceHost"
  win_user_right:
    name: SeSystemProfilePrivilege
    users:
      - Administrators
      - NT SERVICE\WdiServiceHost
    action: set
  when: cis[2019]['2.2.43']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.43

- name: "SCORED | 2.2.44 | POLICY | L1 Ensure Replace a process level token is set to LOCAL SERVICE NETWORK SERVICE"
  win_user_right:
    name: SeAssignPrimaryTokenPrivilege
    users:
      - LOCAL SERVICE
      - NETWORK SERVICE
    action: set
  when: cis[2019]['2.2.44']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.44

- name: "SCORED | 2.2.45 | POLICY | L1 Ensure Restore files and directories is set to Administrators"
  win_user_right:
    name: SeRestorePrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.45']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.45

- name: "SCORED | 2.2.46 | POLICY | L1 Ensure Shut down the system is set to Administrators"
  win_user_right:
    name: SeShutdownPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.46']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.46

- name: "SCORED | 2.2.47 | POLICY | L1 Ensure Synchronize directory service data is set to No One DC only"
  win_user_right:
    name: SeSyncAgentPrivilege
    users: []
    action: set
  when:
    - cis[2019]['2.2.47']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.2.47

- name: "SCORED | 2.2.48 | POLICY | L1 Ensure Take ownership of files or other objects is set to Administrators"
  win_user_right:
    name: SeTakeOwnershipPrivilege
    users:
      - Administrators
    action: set
  when: cis[2019]['2.2.48']
  tags:
    - domaincontroller
    - memberserver
    - control_2.2.48

- name: "SCORED | 2.3.1.1 | POLICY | L1 Ensure Accounts Administrator account status is set to Disabled MS only"
  win_security_policy:
    section: System Access
    key: EnableAdminAccount
    value: 0
  when:
    - cis[2019]['2.3.1.1']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - memberserver
    - control_2.3.1.1

- name: "SCORED | 2.3.1.2 | POLICY | L1 Ensure Accounts Block Microsoft accounts is set to Users cant add or log on with Microsoft accounts"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: NoConnectedUser
    data: 3
    type: dword
  when: cis[2019]['2.3.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.1.2

- name: "SCORED | 2.3.1.3 | POLICY | L1 Ensure Accounts Guest account status is set to Disabled MS only"
  win_security_policy:
    section: System Access
    key: EnableGuestAccount
    value: 0
  when: cis[2019]['2.3.1.3']
  tags:
    - memberserver
    - control_2.3.1.3

- name: "SCORED | 2.3.1.4 | POLICY | L1 Ensure Accounts Limit local account use of blank passwords to console logon only is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: LimitBlankPasswordUse
    data: 1
    type: dword
  when: cis[2019]['2.3.1.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.1.4

- name: "SCORED | 2.3.1.5 | POLICY | L1 Configure Accounts Rename administrator account"
  win_security_policy:
    section: System Access
    key: newadministratorname
    value: "{{ win19cis_admin_username }}"
  when:
    - cis[2019]['2.3.1.5']
    - not win_skip_for_test
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.1.5

- name: "SCORED | 2.3.1.6 | POLICY | L1 Configure Accounts Rename guest account"
  win_security_policy:
    section: System Access
    key: NewGuestName
    value: "{{ win19cis_guest_username }}"
  when: cis[2019]['2.3.1.6']
  tags:
    - domaincontroller
    - memberservers
    - control_2.3.1.6

- name: "SCORED | 2.3.2.1 | POLICY | L1 Ensure Audit Force audit policy subcategory settings Windows Vista or later to override audit policy category settings is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: SCENoApplyLegacyAuditPolicy
    data: 1
    type: dword
  when: cis[2019]['2.3.2.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.2.1

- name: "SCORED | 2.3.2.2 | POLICY | L1 Ensure Audit Shut down system immediately if unable to log security audits is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: CrashOnAuditFail
    data: 0
    type: dword
  when: cis[2019]['2.3.2.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.2.2

- name: "SCORED | 2.3.4.1 | POLICY | L1 Ensure Devices Allowed to format and eject removable media is set to Administrators"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
    name: AllocateDASD
    data: 0
    type: string
  when: cis[2019]['2.3.4.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.4.1

- name: "SCORED | 2.3.4.2 | POLICY | L1 Ensure Devices Prevent users from installing printer drivers is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Print\Providers\Lanman Print Services\Servers
    name: AddPrinterDrivers
    data: 1
    type: dword
  when: cis[2019]['2.3.4.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.4.2

- name: "SCORED | 2.3.5.1 | POLICY | L1 Ensure Domain controller Allow server operators to schedule tasks is set to Disabled DC only"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: SubmitControl
    data: 0
    type: dword
  when:
    - cis[2019]['2.3.5.1']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.3.5.1

- name: "SCORED | 2.3.5.2 | POLICY | L1 Ensure Domain controller LDAP server signing requirements is set to Require signing DC only"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\NTDS\Parameters
    name: LDAPServerIntegrity
    data: 2
    type: dword
  when:
    - cis[2019]['2.3.5.2']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.3.5.2

- name: "SCORED | 2.3.5.3 | POLICY | L1 Ensure Domain controller Refuse machine account password changes is set to Disabled DC only"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters
    name: RefusePasswordChange
    data: 0
    type: dword
  when:
    - cis[2019]['2.3.5.3']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.3.5.3

- name: "SCORED | 2.3.6.1 | POLICY | L1 Ensure Domain member Digitally encrypt or sign secure channel data always is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: RequireSignOrSeal
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.6.1']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.1

- name: "SCORED | 2.3.6.2 | POLICY | L1 Ensure Domain member Digitally encrypt secure channel data when possible is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: sealsecurechannel
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.6.2']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.2

- name: "SCORED | 2.3.6.3 | POLICY | L1 Ensure Domain member Digitally sign secure channel data when possible is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: signsecurechannel
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.6.3']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.3

- name: "SCORED | 2.3.6.4 | POLICY | L1 Ensure Domain member Disable machine account password changes is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: disablepasswordchange
    data: 0
    type: dword
  when:
    - cis[2019]['2.3.6.4']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.4

- name: "SCORED | 2.3.6.5 | POLICY | L1 Ensure Domain member Maximum machine account password age is set to 30 or fewer days but not 0"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: MaximumPasswordAge
    data: 30
    type: dword
  when:
    - cis[2019]['2.3.6.5']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.5

- name: "SCORED | 2.3.6.6 | POLICY | L1 Ensure Domain member Require strong Windows 2000 or later session key is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netlogon\Parameters
    name: RequireStrongKey
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.6.6']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.6.6

- name: "SCORED | 2.3.7.1 | POLICY | L1 Ensure Interactive logon Do not require CTRLALTDEL is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: DisableCAD
    data: 0
    type: dword
  when: cis[2019]['2.3.7.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.1

- name: "SCORED | 2.3.7.2 | POLICY | L1 Ensure Interactive logon Dont display last signed-in is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: DontDisplayLastUserName
    data: 1
    type: dword
  when: cis[2019]['2.3.7.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.2

- name: "SCORED | 2.3.7.3 | POLICY | L1 Ensure Interactive logon Machine inactivity limit is set to 900 or fewer seconds but not 0"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: InactivityTimeoutSecs
    data: 900
    type: dword
  when: cis[2019]['2.3.7.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.3

- name: "SCORED | 2.3.7.4 | POLICY | L1 Configure Interactive logon Message text for users attempting to log on"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: LegalNoticeText
    data: "{{ legalnoticetext }}"
    type: string
  when: cis[2019]['2.3.7.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.4

- name: "SCORED | 2.3.7.5 | POLICY | L1 Configure Interactive logon Message title for users attempting to log on"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: LegalNoticeCaption
    data: "{{ legalnoticecaption }}"
    type: string
  when: cis[2019]['2.3.7.5']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.5

- name: "SCORED | 2.3.7.7 | POLICY | L1 Ensure Interactive logon Prompt user to change password before expiration is set to between 5 and 14 days"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
    name: PasswordExpiryWarning
    data: 14
    type: dword
  when: cis[2019]['2.3.7.7']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.7

- name: "SCORED | 2.3.7.8 | POLICY | L1 Ensure Interactive logon Require Domain Controller Authentication to unlock workstation is set to Enabled MS only"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
    name: ForceUnlockLogon
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.7.8']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.7.8

- name: "SCORED | 2.3.7.9 | POLICY | L1 Ensure Interactive logon Smart card removal behavior is set to Lock Workstation or higher"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
    name: scremoveoption
    data: 1
    type: string
  when: cis[2019]['2.3.7.9']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.7.9

- name: "SCORED | 2.3.8.1 | POLICY | L1 Ensure Microsoft network client Digitally sign communications always is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters
    name: RequireSecuritySignature
    data: 1
    type: dword
  when: cis[2019]['2.3.8.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.8.1

- name: "SCORED | 2.3.8.2 | POLICY | L1 Ensure Microsoft network client Digitally sign communications if server agrees is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters
    name: EnableSecuritySignature
    data: 1
    type: dword
  when: cis[2019]['2.3.8.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.8.2

- name: "SCORED | 2.3.8.3 | POLICY | L1 Ensure Microsoft network client Send unencrypted password to third-party SMB servers is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanworkstation\Parameters
    name: EnablePlainTextPassword
    data: 0
    type: dword
  when: cis[2019]['2.3.8.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.8.3

- name: "SCORED | 2.3.9.1 | POLICY | L1 Ensure Microsoft network server Amount of idle time required before suspending session is set to 15 or fewer minutes"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: autodisconnect
    data: 15
    type: dword
  when: cis[2019]['2.3.9.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.9.1

- name: "SCORED | 2.3.9.2 | POLICY | L1 Ensure Microsoft network server Digitally sign communications always is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: requiresecuritysignature
    data: 1
    type: dword
  when: cis[2019]['2.3.9.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.9.2

- name: "SCORED | 2.3.9.3 | POLICY | L1 Ensure Microsoft network server Digitally sign communications if client agrees is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: enablesecuritysignature
    data: 1
    type: dword
  when: cis[2019]['2.3.9.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.9.3

- name: "SCORED | 2.3.9.4 | POLICY | L1 Ensure Microsoft network server Disconnect clients when logon hours expire is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: enableforcedlogoff
    data: 1
    type: dword
  when: cis[2019]['2.3.9.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.9.4

- name: "SCORED | 2.3.9.5 | POLICY | L1 Ensure Microsoft network server Server SPN target name validation level is set to Accept if provided by client or higher MS only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: SMBServerNameHardeningLevel
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.9.5']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.9.5

- name: "SCORED | 2.3.10.1 | POLICY | L1 Ensure Network access Allow anonymous SIDName translation is set to Disabled"
  win_security_policy:
    section: System Access
    key: LSAAnonymousNameLookup
    value: 0
  when: cis[2019]['2.3.10.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.1

- name: "SCORED | 2.3.10.2 | POLICY | L1 Ensure Network access Do not allow anonymous enumeration of SAM accounts is set to Enabled MS only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: RestrictAnonymousSAM
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.10.2']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.10.2

- name: "SCORED | 2.3.10.3 | POLICY | L1 Ensure Network access Do not allow anonymous enumeration of SAM accounts and shares is set to Enabled MS only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: RestrictAnonymous
    data: 1
    type: dword
  when:
    - cis[2019]['2.3.10.3']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.10.3

- name: "SCORED | 2.3.10.5 | POLICY | L1 Ensure Network access Let Everyone permissions apply to anonymous users is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: EveryoneIncludesAnonymous
    data: 0
    type: dword
  when: cis[2019]['2.3.10.5']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.5

- name: "SCORED | 2.3.10.6 | POLICY | L1 Configure Network access Named Pipes that can be accessed anonymously DC only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: NullSessionPipes
    data: ""
    type: multistring
  when:
    - cis[2019]['2.3.10.6']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_2.3.10.6

- name: "SCORED | 2.3.10.7 | POLICY | L1 Configure Network access Named Pipes that can be accessed anonymously MS only"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: NullSessionPipes
    data: ""
    type: multistring
  when:
    - cis[2019]['2.3.10.7']
    - ansible_windows_domain_role == "Member server"
  tags:
    - memberserver
    - control_2.3.10.7

- name: "SCORED | 2.3.10.8 | POLICY | L1 Configure Network access Remotely accessible registry paths"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Securepipeservers\Winreg\AllowedExactpaths
    name: "Machine"
    data: ['System\CurrentControlSet\Control\ProductOptions', 'System\CurrentControlSet\Control\Server Applications', 'Software\Microsoft\Windows NT\CurrentVersion']
    type: multistring
  when: cis[2019]['2.3.10.8']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.8

- name: "SCORED | 2.3.10.9 | POLICY | L1 Configure Network access Remotely accessible registry paths and sub-paths"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Securepipeservers\Winreg\Allowedpaths
    name: "Machine"
    data: ['System\CurrentControlSet\Control\Print\Printers', 'System\CurrentControlSet\Services\Eventlog', 'Software\Microsoft\OLAP Server', 'Software\Microsoft\Windows NT\CurrentVersion\Print', 'Software\Microsoft\Windows NT\CurrentVersion\Windows', 'System\CurrentControlSet\Control\ContentIndex', 'System\CurrentControlSet\Control\Terminal Server', 'System\CurrentControlSet\Control\Terminal Server\UserConfig', 'System\CurrentControlSet\Control\Terminal Server\DefaultUserConfiguration', 'Software\Microsoft\Windows NT\CurrentVersion\Perflib', 'System\CurrentControlSet\Services\WINS', 'System\CurrentControlSet\Services\CertSvc']
    type: multistring
  when: cis[2019]['2.3.10.9']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.9

- name: "SCORED | 2.3.10.10 | POLICY | L1 Ensure Network access Restrict anonymous access to Named Pipes and Shares is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: RestrictNullSessAccess
    data: 1
    type: dword
  when: cis[2019]['2.3.10.10']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.10

- name: "SCORED | 2.3.10.11 | POLICY | L1 Ensure Network access Restrict clients allowed to make remote calls to SAM is set to Administrators Remote Access Allow MS only"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: RestrictRemoteSAM
    data: "O:BAG:BAD:(A;;RC;;;BA)"
    type: string
  when: cis[2019]['2.3.10.11']
  tags:
    - memberserver
    - control_2.3.10.11

- name: "SCORED | 2.3.10.12 | POLICY | L1 Ensure Network access Shares that can be accessed anonymously is set to None"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Lanmanserver\Parameters
    name: NullSessionShares
    data: ""
    type: multistring
  when: cis[2019]['2.3.10.12']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.12

- name: "SCORED | 2.3.10.13 | POLICY | L1 Ensure Network access Sharing and security model for local accounts is set to Classic - local users authenticate as themselves"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: ForceGuest
    data: 0
    type: dword
  when: cis[2019]['2.3.10.13']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.10.13

- name: "SCORED | 2.3.11.1 | POLICY | L1 Ensure Network security Allow Local System to use computer identity for NTLM is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: UseMachineId
    data: 1
    type: dword
  when: cis[2019]['2.3.11.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.1

- name: "SCORED | 2.3.11.2 | POLICY | L1 Ensure Network security Allow LocalSystem NULL session fallback is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa\Msv1_0
    name: allownullsessionfallback
    data: 0
    type: dword
  when: cis[2019]['2.3.11.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.2

- name: "SCORED | 2.3.11.3 | POLICY | L1 Ensure Network Security Allow PKU2U authentication requests to this computer to use online identities is set to Disabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa\Pku2U
    name: AllowOnlineID
    data: 0
    type: dword
  when: cis[2019]['2.3.11.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.3

- name: "SCORED | 2.3.11.4 | POLICY | L1 Ensure Network security Configure encryption types allowed for Kerberos is set to AES128 HMAC SHA1 AES256 HMAC SHA1 Future encryption types"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System\Kerberos\Parameters
    name: SupportedEncryptionTypes
    data: 2147483640
    type: dword
  when: cis[2019]['2.3.11.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.4

- name: "SCORED | 2.3.11.5 | POLICY | L1 Ensure Network security Do not store LAN Manager hash value on next password change is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: NoLMHash
    data: 1
    type: dword
  when: cis[2019]['2.3.11.5']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.5

- name: "SCORED | 2.3.11.6 | POLICY | L1 Ensure Network security Force logoff when logon hours expire is set to Enabled"
  win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
    name: EnableForcedLogOff
    data: 1
    type: dword
  when: cis[2019]['2.3.11.6']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.6

- name: "SCORED | 2.3.11.7 | POLICY | L1 Ensure Network security LAN Manager authentication level is set to Send NTLMv2 response only. Refuse LM  NTLM"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa
    name: LMCompatibilityLevel
    data: 5
    type: dword
  when: cis[2019]['2.3.11.7']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.7

- name: "SCORED | 2.3.11.8 | POLICY | L1 Ensure Network security LDAP client signing requirements is set to Negotiate signing or higher"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Ldap
    name: LDAPClientIntegrity
    data: 1
    type: dword
  when: cis[2019]['2.3.11.8']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.8

- name: "SCORED | 2.3.11.9 | POLICY | L1 Ensure Network security Minimum session security for NTLM SSP based including secure RPC clients is set to Require NTLMv2 session security Require 128-bit encryption"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa\Msv1_0
    name: NTLMMinClientSec
    data: 537395200
    type: dword
  when: cis[2019]['2.3.11.9']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.9

- name: "SCORED | 2.3.11.10 | POLICY | L1 Ensure Network security Minimum session security for NTLM SSP based including secure RPC servers is set to Require NTLMv2 session security Require 128-bit encryption"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Lsa\Msv1_0
    name: NTLMMinServerSec
    data: 537395200
    type: dword
  when: cis[2019]['2.3.11.10']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.11.10

- name: "SCORED | 2.3.13.1 | POLICY | L1 Ensure Shutdown Allow system to be shut down without having to log on is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: ShutdownWithoutLogon
    data: 0
    type: dword
  when: cis[2019]['2.3.13.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.13.1

- name: "SCORED | 2.3.15.1 | POLICY | L1 Ensure System objects Require case insensitivity for non-Windows subsystems is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Session Manager\Kernel
    name: ObCaseInsensitive
    data: 1
    type: dword
  when: cis[2019]['2.3.15.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.15.1

- name: "SCORED | 2.3.15.2 | POLICY | L1 Ensure System objects Strengthen default permissions of internal system objects e.g. Symbolic Links is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Session Manager
    name: ProtectionMode
    data: 1
    type: dword
  when: cis[2019]['2.3.15.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.15.2

- name: "SCORED | 2.3.17.1 | POLICY | L1 Ensure User Account Control Admin Approval Mode for the Built-in Administrator account is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: FilterAdministratorToken
    data: 1
    type: dword
  when: cis[2019]['2.3.17.1']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.1

- name: "SCORED | 2.3.17.2 | POLICY | L1 Ensure User Account Control Behavior of the elevation prompt for administrators in Admin Approval Mode is set to Prompt for consent on the secure desktop"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: ConsentPromptBehaviorAdmin
    data: 2
    type: dword
  when: cis[2019]['2.3.17.2']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.2

- name: "SCORED | 2.3.17.3 | POLICY | L1 Ensure User Account Control Behavior of the elevation prompt for standard users is set to Automatically deny elevation requests"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: ConsentPromptBehaviorUser
    data: 0
    type: dword
  when: cis[2019]['2.3.17.3']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.3

- name: "SCORED | 2.3.17.4 | POLICY | L1 Ensure User Account Control Detect application installations and prompt for elevation is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: EnableInstallerDetection
    data: 1
    type: dword
  when: cis[2019]['2.3.17.4']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.4

- name: "SCORED | 2.3.17.5 | POLICY | L1 Ensure User Account Control Only elevate UIAccess applications that are installed in secure locations is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: EnableSecureUIAPaths
    data: 1
    type: dword
  when: cis[2019]['2.3.17.5']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.5

- name: "SCORED | 2.3.17.6 | POLICY | L1 Ensure User Account Control Run all administrators in Admin Approval Mode is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: EnableLUA
    data: 1
    type: dword
  when: cis[2019]['2.3.17.6']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.6

- name: "SCORED | 2.3.17.7 | POLICY | L1 Ensure User Account Control Switch to the secure desktop when prompting for elevation is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: PromptOnSecureDesktop
    data: 1
    type: dword
  when: cis[2019]['2.3.17.7']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.7

- name: "SCORED | 2.3.17.8 | POLICY | L1 Ensure User Account Control Virtualize file and registry write failures to per-user locations is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: EnableVirtualization
    data: 1
    type: dword
  when: cis[2019]['2.3.17.8']
  tags:
    - domaincontroller
    - memberserver
    - control_2.3.17.8

# Section 9

- name: "SCORED | 9.1.1 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Firewall state' is set to 'On (recommended)'"
  win_firewall:
    state: enabled
    profile: Domain
  when: cis[2019]['9.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.1

- name: "SCORED | 9.1.2 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Inbound connections' is set to 'Block (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile
    name: DefaultInboundAction
    data: 1
    type: dword
  when: cis[2019]['9.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.2

- name: "SCORED | 9.1.3 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Outbound connections' is set to 'Allow (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile
    name: DefaultOutboundAction
    data: 0
    type: dword
  when: cis[2019]['9.1.3']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.3

- name: "SCORED | 9.1.4 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Settings: Display a notification' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile
    name: DisableNotifications
    data: 1
    type: dword
  when: cis[2019]['9.1.4']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.4

# title has slashes switched
- name: "SCORED | 9.1.5 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Logging: Name' is set to '%SystemRoot%/System32/logfiles/firewall/domainfw.log'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogFilePath
    data: '{{ domain_firewall_log_path }}'
    type: string
  when: cis[2019]['9.1.5']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.5

- name: "SCORED | 9.1.6 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Logging: Size limit (KB)' is set to '16,384 KB or greater'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogFileSize
    data: '{{ domain_firewall_log_size }}'
    type: dword
  when: cis[2019]['9.1.6']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.6

- name: "SCORED | 9.1.7 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Logging: Log dropped packets' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogDroppedPackets
    data: 1
    type: dword
  when: cis[2019]['9.1.7']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.7

- name: "SCORED | 9.1.8 | POLICY | (L1) Ensure 'Windows Firewall: Domain: Logging: Log successful connections' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogSuccessfulConnections
    data: 1
    type: dword
  when: cis[2019]['9.1.8']
  tags:
    - domaincontroller
    - memberserver
    - control_9.1.7

- name: "SCORED | 9.2.1 | POLICY | (L1) Ensure 'Windows Firewall: Private: Firewall state' is set to 'On (recommended)'"
  win_firewall:
    state: enabled
    profile: Private
  when: cis[2019]['9.2.1']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.1

- name: "SCORED | 9.2.2 | POLICY | (L1) Ensure 'Windows Firewall: Private: Inbound connections' is set to 'Block (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile
    name: DefaultInboundAction
    data: 1
    type: dword
  when: cis[2019]['9.2.2']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.2

- name: "SCORED | 9.2.3 | POLICY | (L1) Ensure 'Windows Firewall: Private: Outbound connections' is set to 'Allow (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile
    name: DefaultOutboundAction
    data: 0
    type: dword
  when: cis[2019]['9.2.3']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.3

- name: "SCORED | 9.2.4 | POLICY | (L1) Ensure 'Windows Firewall: Private: Settings: Display a notification' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile
    name: DisableNotifications
    data: 1
    type: dword
  when: cis[2019]['9.2.4']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.4

# title has slashes switched
- name: "SCORED | 9.2.5 | POLICY | (L1) Ensure 'Windows Firewall: Private: Logging: Name' is set to '%SystemRoot%/System32/logfiles/firewall/privatefw.log'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging
    name: LogFilePath
    data: '{{ private_firewall_log_path }}'
    type: string
  when: cis[2019]['9.2.5']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.5

- name: "SCORED | 9.2.6 | POLICY | (L1) Ensure 'Windows Firewall: Private: Logging: Size limit (KB)' is set to '16,384 KB or greater'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging
    name: LogFileSize
    data: '{{ private_firewall_log_size }}'
    type: dword
  when: cis[2019]['9.2.6']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.6

- name: "SCORED | 9.2.7 | POLICY | (L1) Ensure 'Windows Firewall: Private: Logging: Log dropped packets' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging
    name: LogDroppedPackets
    data: 1
    type: dword
  when: cis[2019]['9.2.7']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.7

- name: "SCORED | 9.2.8 | POLICY | (L1) Ensure 'Windows Firewall: Private: Logging: Log successful connections' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PrivateProfile\Logging
    name: LogSuccessfulConnections
    data: 1
    type: dword
  when: cis[2019]['9.2.8']
  tags:
    - domaincontroller
    - memberserver
    - control_9.2.8

- name: "SCORED | 9.3.1 | POLICY | (L1) Ensure 'Windows Firewall: Public: Firewall state' is set to 'On (recommended)'"
  win_firewall:
    state: enabled
    profile: Public
  when: cis[2019]['9.3.1']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.1

- name: "SCORED | 9.3.2 | POLICY | (L1) Ensure 'Windows Firewall: Public: Inbound connections' is set to 'Block (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: DefaultInboundAction
    data: 1
    type: dword
  when: cis[2019]['9.3.2']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.2

- name: "SCORED | 9.3.3 | POLICY | (L1) Ensure 'Windows Firewall: Public: Outbound connections' is set to 'Allow (default)'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: DefaultOutboundAction
    data: 0
    type: dword
  when: cis[2019]['9.3.3']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.3

- name: "SCORED | 9.3.4 | POLICY | (L1) Ensure 'Windows Firewall: Public: Settings: Display a notification' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: DisableNotifications
    data: 1
    type: dword
  when: cis[2019]['9.3.4']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.4

- name: "SCORED | 9.3.5 | POLICY | (L1) Ensure 'Windows Firewall: Public: Settings: Apply local firewall rules' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: AllowLocalPolicyMerge
    data: 0
    type: dword
  when:
    - cis[2019]['9.3.5']
    - not win_skip_for_test
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.5

- name: "SCORED | 9.3.6 | POLICY | (L1) Ensure 'Windows Firewall: Public: Settings: Apply local connection security rules' is set to 'No'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: AllowLocalIPsecPolicyMerge
    data: 0
    type: dword
  when: cis[2019]['9.3.6']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.6

# title has slashes switched
- name: "SCORED | 9.3.7 | POLICY | (L1) Ensure 'Windows Firewall: Public: Logging: Name' is set to '%SystemRoot%/System32/logfiles/firewall/publicfw.log'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging
    name: LogFilePath
    data: '{{ public_firewall_log_path }}'
    type: string
  when: cis[2019]['9.3.7']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.7

- name: "SCORED | 9.3.8 | POLICY | (L1) Ensure 'Windows Firewall: Public: Logging: Size limit (KB)' is set to '16,384 KB or greater'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging
    name: LogFileSize
    data: '{{ public_firewall_log_size }}'
    type: dword
  when: cis[2019]['9.3.8']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.8

- name: "SCORED | 9.3.9 | POLICY | (L1) Ensure 'Windows Firewall: Public: Logging: Log dropped packets' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging
    name: LogDroppedPackets
    data: 1
    type: dword
  when: cis[2019]['9.3.9']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.9

- name: "SCORED | 9.3.10 | POLICY | (L1) Ensure 'Windows Firewall: Public: Logging: Log successful connections' is set to 'Yes'"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile\Logging
    name: LogSuccessfulConnections
    data: 1
    type: dword
  when: cis[2019]['9.3.10']
  tags:
    - domaincontroller
    - memberserver
    - control_9.3.10

# Section 17

- name: "SCORED | 17.1.1 | POLICY | L1 Ensure Audit Credential Validation is set to Success and Failure"
  block:
    - name: "SCORED | 17.1.1 | AUDIT | L1 Ensure Audit Credential Validation is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Credential Validation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_1_1_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.1.1 | POLICY | L1 Ensure Audit Credential Validation is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Credential Validation" /success:enable
      when: "'Success' not in rule_17_1_1_audit.stdout"
      changed_when: "'Success' not in rule_17_1_1_audit.stdout"

    - name: "SCORED | 17.1.1 | POLICY | L1 Ensure Audit Credential Validation is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Credential Validation" /failure:enable
      when: "'Failure' not in rule_17_1_1_audit.stdout"
      changed_when: "'Failure' not in rule_17_1_1_audit.stdout"
  when:
    - cis[2019]['17.1.1']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_17.1.1

- name: "SCORED | 17.1.2 | POLICY | L1 Ensure 'Audit Kerberos Authentication Service' is set to 'Success and Failure' DC Only"
  block:
    - name: "SCORED | 17.1.2 | AUDIT | L1 Ensure 'Audit Kerberos Authentication Service' is set to 'Success and Failure' DC Only"
      win_shell: AuditPol /get /subcategory:"Kerberos Authentication Service" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_1_2_audit

    - name: "SCORED | 17.1.2 | POLICY | L1 Ensure 'Audit Kerberos Authentication Service' is set to 'Success and Failure' DC Only"
      win_shell: AuditPol /set /subcategory:"Kerberos Authentication Service" /success:enable
      when: "'Success' not in rule_17_1_2_audit.stdout"

    - name: "SCORED | 17.1.2 | POLICY | L1 Ensure 'Audit Kerberos Authentication Service' is set to 'Success and Failure' DC Only"
      win_shell: AuditPol /set /subcategory:"Kerberos Authentication Service" /failure:enable
      when: "'Failure' not in rule_17_1_2_audit.stdout"
  when:
    - cis[2019]['17.1.2']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.1.2

- name: "SCORED | 17.1.3 | POLICY | L1 Ensure 'Audit Kerberos Service Ticket Operations' is set to 'Success and Failure'"
  block:
    - name: "SCORED | 17.1.3 | AUDIT | L1 Ensure 'Audit Kerberos Service Ticket Operations' is set to 'Success and Failure'"
      win_shell: AuditPol /get /subcategory:"Kerberos Service Ticket Operations" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_1_3_audit

    - name: "SCORED | 17.1.3 | POLICY | L1 Ensure 'Audit Kerberos Service Ticket Operations' is set to 'Success and Failure'"
      win_shell: AuditPol /set /subcategory:"Kerberos Service Ticket Operations" /success:enable
      when: "'Success' not in rule_17_1_3_audit.stdout"

    - name: "SCORED | 17.1.3 | POLICY | L1 Ensure 'Audit Kerberos Service Ticket Operations' is set to 'Success and Failure'"
      win_shell: AuditPol /set /subcategory:"Kerberos Service Ticket Operations" /failure:enable
      when: "'Failure' not in rule_17_1_3_audit.stdout"
  when:
    - cis[2019]['17.1.3']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.1.3

- name: "SCORED | 17.2.1 | POLICY | L1 Ensure Audit Application Group Management is set to Success and Failure"
  block:
    - name: "SCORED | 17.2.1 | AUDIT | L1 Ensure Audit Application Group Management is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Security Group Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_1_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.1 | POLICY | L1 Ensure Audit Application Group Management is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Security Group Management" /success:enable
      when: "'Success' not in rule_17_2_1_audit.stdout"

    - name: "SCORED | 17.2.1 | POLICY | L1 Ensure Audit Application Group Management is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Security Group Management" /failure:enable
      when: "'Failure' not in rule_17_2_1_audit.stdout"
  when:
    - cis[2019]['17.2.1']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_17.2.1

- name: "SCORED | 17.2.2 | POLICY | L1 Ensure Audit Computer Account Management is set to include Success DC only"
  block:
    - name: "SCORED | 17.2.2 | AUDIT | L1 Ensure Audit Computer Account Management is set to include Success DC only"
      win_shell: AuditPol /get /subcategory:"Computer Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_2_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.2 | POLICY | L1 Ensure Audit Computer Account Management is set to include Success DC only"
      win_shell: AuditPol /set /subcategory:"Computer Account Management" /success:enable
      changed_when: "'Success' not in rule_17_2_2_audit.stdout"
      when: "'Success' not in rule_17_2_2_audit.stdout"
  when:
    - cis[2019]['17.2.2']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.2.2

- name: "SCORED | 17.2.3 | POLICY | L1 Ensure Audit Distribution Group Management is set to include Success DC only"
  block:
    - name: "SCORED | 17.2.3 | AUDIT | L1 Ensure Audit Distribution Group Management is set to include Success DC only"
      win_shell: AuditPol /get /subcategory:"Distribution Group Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_3_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.3 | POLICY | L1 Ensure Audit Distribution Group Management is set to include Success DC only"
      win_shell: AuditPol /set /subcategory:"Distribution Group Management" /success:enable
      when: "'Success' not in rule_17_2_3_audit.stdout"
  when:
    - cis[2019]['17.2.3']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.2.3

- name: "SCORED | 17.2.4 | POLICY | L1 Ensure Audit Other Account Management Events is set to include Success DC only"
  block:
    - name: "SCORED | 17.2.4 | AUDIT | L1 Ensure Audit Other Account Management Events is set to include Success DC only"
      win_shell: AuditPol /get /subcategory:"Other Account Management Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_4_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.4 | POLICY | L1 Ensure Audit Other Account Management Events is set to include Success DC only"
      win_shell: AuditPol /set /subcategory:"Other Account Management Events" /success:enable
      when: "'Success' not in rule_17_2_4_audit.stdout"
  when:
    - cis[2019]['17.2.4']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.2.4

- name: "SCORED | 17.2.5 | AUDIT | L1 Ensure Audit Security Group Management is set to include Success"
  block:
    - name: "SCORED | 17.2.5 | AUDIT | L1 Ensure Audit Security Group Management is set to include Success"
      win_shell: AuditPol /get /subcategory:"Security Group Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      register: rule_17_2_5_audit
      changed_when: false
      failed_when: false

    - name: "SCORED | 17.2.5 | POLICY | L1 Ensure Audit Security Group Management is set to include Success"
      win_shell: AuditPol /set /subcategory:"Security Group Management" /success:enable
      when: "'Success' not in rule_17_2_5_audit.stdout"
  when: cis[2019]['17.2.5']
  tags:
    - domaincontroller
    - memberserver
    - control_17.2.5

- name: "SCORED | 17.2.6 | POLICY | L1 Ensure Audit User Account Management is set to Success and Failure"
  block:
    - name: "SCORED | 17.2.6 | AUDIT | L1 Ensure Audit User Account Management is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"User Account Management" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_2_6_audit

    - name: "SCORED | 17.2.6 | POLICY | L1 Ensure Audit User Account Management is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"User Account Management" /success:enable
      when: "'Success' not in rule_17_2_6_audit.stdout"

    - name: "SCORED | 17.2.6 | POLICY | L1 Ensure Audit User Account Management is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"User Account Management" /failure:enable
      when: "'Failure' not in rule_17_2_6_audit.stdout"
  when: cis[2019]['17.2.6']
  tags:
      - domaincontroller
      - memberserver
      - control_17.2.6

- name: "SCORED | 17.3.1 | POLICY | L1 Ensure Audit PNP Activity is set to include Success"
  block:
    - name: "SCORED | 17.3.1 | AUDIT | L1 Ensure Audit PNP Activity is set to include Success"
      win_shell: AuditPol /get /subcategory:"Plug and Play Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_3_1_audit

    - name: "SCORED | 17.3.1 | POLICY | L1 Ensure Audit PNP Activity is set to include Success"
      win_shell: AuditPol /set /subcategory:"Plug and Play Events" /success:enable
      when: "'Success' not in rule_17_3_1_audit.stdout"
  when: cis[2019]['17.3.1']
  tags:
      - domaincontroller
      - memberserver
      - control_17.3.1

- name: "SCORED | 17.3.2 | POLICY | L1 Ensure Audit Process Creation is set to include Success"
  block:
    - name: "SCORED | 17.3.2 | AUDIT | L1 Ensure Audit Process Creation is set to include Success"
      win_shell: AuditPol /get /subcategory:"Process Creation" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_3_2_audit

    - name: "SCORED | 17.3.2 | POLICY | L1 Ensure Audit Process Creation is set to include Success"
      win_shell: AuditPol /set /subcategory:"Process Creation" /success:enable
      when: "'Success' not in rule_17_3_2_audit.stdout"
  when: cis[2019]['17.3.2']
  tags:
    - domaincontroller
    - memberserver
    - control_17.3.2

- name: "SCORED | 17.4.1 | POLICY | L1 Ensure Audit Directory Service Access is set to include Failure DC only"
  block:
    - name: "SCORED | 17.4.1 | AUDIT | L1 Ensure Audit Directory Service Access is set to include Failure DC only"
      win_shell: AuditPol /get /subcategory:"Directory Service Access" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_4_1_audit

    - name: "SCORED | 17.4.1 | POLICY | L1 Ensure Audit Directory Service Access is set to include Failure DC only"
      win_shell: AuditPol /set /subcategory:"Directory Service Access" /success:enable
      when: "'Success' not in rule_17_4_1_audit.stdout"
  when:
    - cis[2019]['17.4.1']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_17.4.1

- name: "SCORED | 17.4.2 | POLICY | L1 Ensure Audit Directory Service Changes is set to include Success DC only"
  block:
    - name: "SCORED | 17.4.2 | AUDIT | L1 Ensure Audit Directory Service Changes is set to include Success DC only"
      win_shell: AuditPol /get /subcategory:"Directory Service Changes" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_4_2_audit

    - name: "SCORED | 17.4.2 | POLICY | L1 Ensure Audit Directory Service Changes is set to include Success DC only"
      win_shell: AuditPol /set /subcategory:"Directory Service Changes" /success:enable
      when: "'Success' not in rule_17_4_2_audit.stdout"
  when:
    - cis[2019]['17.4.2']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
      - domaincontroller
      - control_17.4.2

- name: "SCORED | 17.5.1 | POLICY | L1 Ensure Audit Account Lockout is set to include Failure"
  block:
    - name: "SCORED | 17.5.1 | AUDIT | L1 Ensure Audit Account Lockout is set to include Failure"
      win_shell: AuditPol /get /subcategory:"Account Lockout" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_1_audit

    - name: "SCORED | 17.5.1 | POLICY | L1 Ensure Audit Account Lockout is set to include Failure"
      win_shell: AuditPol /set /subcategory:"Account Lockout" /failure:enable
      when: "'Failure' not in rule_17_5_1_audit.stdout"
  when: cis[2019]['17.5.1']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.1

- name: "SCORED | 17.5.2 | POLICY | L1 Ensure Audit Group Membership is set to include Success"
  block:
    - name: "SCORED | 17.5.2 | AUDIT | L1 Ensure Audit Group Membership is set to include Success"
      win_shell: AuditPol /get /subcategory:"Group Membership" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_2_audit

    - name: "SCORED | 17.5.2 | POLICY | L1 Ensure Audit Group Membership is set to include Success"
      win_shell: AuditPol /set /subcategory:"Group Membership" /success:enable
      when: "'Success' not in rule_17_5_2_audit.stdout"
  when: cis[2019]['17.5.2']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.2

- name: "SCORED | 17.5.3 | AUDIT | L1 Ensure Audit Logoff is set to include Success"
  block:
    - name: "SCORED | 17.5.3 | AUDIT | L1 Ensure Audit Logoff is set to include Success"
      win_shell: AuditPol /get /subcategory:"Logoff" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_3_audit

    - name: "SCORED | 17.5.3 | POLICY | L1 Ensure Audit Logoff is set to include Success"
      win_shell: AuditPol /set /subcategory:"Logoff" /success:enable
      when: "'Success' not in rule_17_5_3_audit.stdout"
  when: cis[2019]['17.5.3']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.3

- name: "SCORED | 17.5.4 | POLICY | L1 Ensure Audit Logon is set to Success and Failure"
  block:
    - name: "SCORED | 17.5.4 | AUDIT | L1 Ensure Audit Logon is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_4_audit

    - name: "SCORED | 17.5.4 | POLICY | L1 Ensure Audit Logon is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Logon" /success:enable
      when: "'Failure' not in rule_17_5_4_audit.stdout"

    - name: "SCORED | 17.5.4 | POLICY | L1 Ensure Audit Logon is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Logon" /failure:enable
      when: "'Failure' not in rule_17_5_4_audit.stdout"
  when: cis[2019]['17.5.4']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.4

- name: "SCORED | 17.5.5 | POLICY | L1 Ensure Audit Other LogonLogoff Events is set to Success and Failure"
  block:
    - name: "SCORED | 17.5.5 | AUDIT | L1 Ensure Audit Other LogonLogoff Events is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Other Logon/Logoff Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_5_audit

    - name: "SCORED | 17.5.5 | POLICY | L1 Ensure Audit Other LogonLogoff Events is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Other Logon/Logoff Events" /success:enable
      when: "'Success' not in rule_17_5_5_audit.stdout"

    - name: "SCORED | 17.5.5 | POLICY | L1 Ensure Audit Other LogonLogoff Events is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Other Logon/Logoff Events" /failure:enable
      when: "'Failure' not in rule_17_5_5_audit.stdout"
  when: cis[2019]['17.5.5']
  tags:
    - domaincontroller
    - memberserver
    - control_17.5.5  

- name: "SCORED | 17.5.6 | POLICY | L1 Ensure Audit Special Logon is set to include Success"
  block:
    - name: "SCORED | 17.5.6 | AUDIT | L1 Ensure Audit Special Logon is set to include Success"
      win_shell: AuditPol /get /subcategory:"Special Logon" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_5_6_audit

    - name: "SCORED | 17.5.6 | POLICY | L1 Ensure Audit Special Logon is set to include Success"
      win_shell: AuditPol /set /subcategory:"Special Logon" /success:enable
      when: "'Success' not in rule_17_5_6_audit.stdout"
  when: cis[2019]['17.5.6']
  tags:
      - domaincontroller
      - memberserver
      - control_17.5.6

- name: "SCORED | 17.6.1 | POLICY | L1 Ensure Audit Detailed File Share is set to include Failure"
  block:
    - name: "SCORED | 17.6.1 | AUDIT | L1 Ensure Audit Detailed File Share is set to include Failure"
      win_shell: AuditPol /get /subcategory:"Detailed File Share" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_6_1_audit

    - name: "SCORED | 17.6.1 | POLICY | L1 Ensure Audit Detailed File Share is set to include Failure"
      win_shell: AuditPol /set /subcategory:"Detailed File Share" /failure:enable
      when: "'Failure' not in rule_17_6_1_audit.stdout"
  when: cis[2019]['17.6.1']
  tags:
    - domaincontroller
    - memberserver
    - control_17.6.1

- name: "SCORED | 17.6.2 | POLICY | L1 Ensure Audit File Share is set to Success and Failure"
  block:
    - name: "SCORED | 17.6.2 | AUDIT | L1 Ensure Audit File Share is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"File Share" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_6_2_audit

    - name: "SCORED | 17.6.2 | POLICY | L1 Ensure Audit File Share is set to Success and Failure"
      win_shell: AuditPol /set /subcategory:"File Share" /failure:enable
      when: "'Failure' not in rule_17_6_2_audit.stdout"
  when: cis[2019]['17.6.2']
  tags:
    - domaincontroller
    - memberserver
    - control_17.6.2

- name: "SCORED | 17.6.3 | POLICY | L1 Ensure Audit Other Object Access Events is set to Success and Failure"
  win_audit_policy_system:
    subcategory: Other Object Access Events
    audit_type: success, failure
  when: cis[2019]['17.6.3']
  tags:
    - domaincontroller
    - memberserver
    - control_17.6.3

- name: "SCORED | 17.6.4 | POLICY | L1 Ensure Audit Removable Storage is set to Success and Failure"
  block:
    - name: "SCORED | 17.6.4 | AUDIT | L1 Ensure Audit Removable Storage is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Removable Storage" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_6_4_audit

    - name: "SCORED | 17.6.4 | POLICY | L1 Ensure Audit Removable Storage is set to Success and Failure"
      win_shell: AuditPol /set /subcategory:"Removable Storage" /success:enable
      when: "'Success' not in rule_17_6_4_audit.stdout"
  when: cis[2019]['17.6.4']
  tags:
    - domaincontroller
    - memberserver
    - control_17.6.4

- name: "SCORED | 17.7.1 | POLICY | L1 Ensure Audit Audit Policy Change is set to include Success"
  block:
    - name: "SCORED | 17.7.1 | AUDIT | L1 Ensure Audit Audit Policy Change is set to include Success"
      win_shell: AuditPol /get /subcategory:"Audit Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_1_audit

    - name: "SCORED | 17.7.1 | POLICY | L1 Ensure Audit Audit Policy Change is set to include Success"
      win_shell: AuditPol /set /subcategory:"Audit Policy Change" /success:enable
      when: "'Success' not in rule_17_7_1_audit.stdout"
  when: cis[2019]['17.7.1']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.1

- name: "SCORED | 17.7.2 | POLICY | L1 Ensure Audit Authentication Policy Change is set to include Success"
  block:
    - name: "SCORED | 17.7.2 | AUDIT | L1 Ensure Audit Authentication Policy Change is set to include Success"
      win_shell: AuditPol /get /subcategory:"Authentication Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_2_audit

    - name: "SCORED | 17.7.2 | POLICY | L1 Ensure Audit Authentication Policy Change is set to include Success"
      win_shell: AuditPol /set /subcategory:"Authentication Policy Change" /success:enable
      when: "'Success' not in rule_17_7_2_audit.stdout"
  when: cis[2019]['17.7.2']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.2

- name: "SCORED | 17.7.3 | POLICY | L1 Ensure Audit Authorization Policy Change is set to include Success"
  block:
    - name: "SCORED | 17.7.3 | AUDIT | L1 Ensure Audit Authorization Policy Change is set to include Success"
      win_shell: AuditPol /get /subcategory:"Authorization Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_3_audit

    - name: "SCORED | 17.7.3 | POLICY | L1 Ensure Audit Authorization Policy Change is set to include Success"
      win_shell: AuditPol /set /subcategory:"Authorization Policy Change" /success:enable
      when: "'Success' not in rule_17_7_3_audit.stdout"
  when: cis[2019]['17.7.3']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.3

- name: "SCORED | 17.7.4 | POLICY | L1 Ensure Audit MPSSVC Rule-Level Policy Change is set to Success and Failure"
  block:
    - name: "SCORED | 17.7.4 | AUDIT | L1 Ensure Audit MPSSVC Rule-Level Policy Change is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"MPSSVC Rule-Level Policy Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_4_audit

    - name: "SCORED | 17.7.4 | POLICY | L1 Ensure Audit MPSSVC Rule-Level Policy Change is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"MPSSVC Rule-Level Policy Change" /success:enable
      when: "'Success' not in rule_17_7_4_audit.stdout"

    - name: "SCORED | 17.7.4 | POLICY | L1 Ensure Audit MPSSVC Rule-Level Policy Change is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"MPSSVC Rule-Level Policy Change" /failure:enable
      when: "'Failure' not in rule_17_7_4_audit.stdout"
  when: cis[2019]['17.7.4']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.4

- name: "SCORED | 17.7.5 | POLICY | L1 Ensure Audit Other Policy Change Events is set to include Failure"
  block:
    - name: "SCORED | 17.7.5 | AUDIT | L1 Ensure Audit Other Policy Change Events is set to include Failure"
      win_shell: AuditPol /get /subcategory:"Other Policy Change Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_7_5_audit

    - name: "SCORED | 17.7.5 | POLICY | L1 Ensure Audit Other Policy Change Events is set to include Failure"
      win_shell: AuditPol /set /subcategory:"Other Policy Change Events" /success:enable
      when: "'Success' not in rule_17_7_5_audit.stdout"
  when: cis[2019]['17.7.5']
  tags:
    - domaincontroller
    - memberserver
    - control_17.7.5

- name: "SCORED | 17.8.1 | POLICY | L1 Ensure Audit Sensitive Privilege Use is set to Success and Failure"
  block:
    - name: "SCORED | 17.8.1 | AUDIT | L1 Ensure Audit Sensitive Privilege Use is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_8_1_audit

    - name: "SCORED | 17.8.1 | POLICY | L1 Ensure Audit Sensitive Privilege Use is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /success:enable
      when: "'Success' not in rule_17_8_1_audit.stdout"

    - name: "SCORED | 17.8.1 | POLICY | L1 Ensure Audit Sensitive Privilege Use is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /failure:enable
      when: "'Failure' not in rule_17_8_1_audit.stdout"
  when: cis[2019]['17.8.1']
  tags:
    - domaincontroller
    - memberserver
    - control_17.8.1

- name: "SCORED | 17.9.1 | POLICY | L1 Ensure Audit IPsec Driver is set to Success and Failure"
  block:
    - name: "SCORED | 17.9.1 | AUDIT | L1 Ensure Audit IPsec Driver is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"IPsec Driver" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_1_audit

    - name: "SCORED | 17.9.1 | POLICY | L1 Ensure Audit IPsec Driver is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"IPsec Driver" /success:enable
      when: "'Success' not in rule_17_9_1_audit.stdout"

    - name: "SCORED | 17.9.1 | POLICY | L1 Ensure Audit IPsec Driver is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"IPsec Driver" /failure:enable
      when: "'Failure' not in rule_17_9_1_audit.stdout"
  when: cis[2019]['17.9.1']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.1

- name: "SCORED | 17.9.2 | POLICY | L1 Ensure Audit Other System Events is set to Success and Failure"
  block:
    - name: "SCORED | 17.9.2 | AUDIT | L1 Ensure Audit Other System Events is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"Other System Events" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_2_audit

    - name: "SCORED | 17.9.2 | POLICY | L1 Ensure Audit Other System Events is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"Other System Events" /success:enable
      when: "'Success' not in rule_17_9_2_audit.stdout"

    - name: "SCORED | 17.9.2 | POLICY | L1 Ensure Audit Other System Events is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"Other System Events" /failure:enable
      when: "'Failure' not in rule_17_9_2_audit.stdout"
  when: cis[2019]['17.9.2']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.2

- name: "SCORED | 17.9.3 | POLICY | L1 Ensure Audit Security State Change is set to include Success"
  block:
    - name: "SCORED | 17.9.3 | AUDIT | L1 Ensure Audit Security State Change is set to include Success"
      win_shell: AuditPol /get /subcategory:"Security State Change" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_3_audit

    - name: "SCORED | 17.9.3 | POLICY | L1 Ensure Audit Security State Change is set to include Success"
      win_shell: AuditPol /set /subcategory:"Security State Change" /success:enable
      when: "'Success' not in rule_17_9_3_audit.stdout"
  when: cis[2019]['17.9.3']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.3

- name: "SCORED | 17.9.4 | POLICY | L1 Ensure Audit Security System Extension is set to include Success"
  block:
    - name: "SCORED | 17.9.4 | AUDIT | L1 Ensure Audit Security System Extension is set to include Success"
      win_shell: AuditPol /get /subcategory:"Security System Extension" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_4_audit

    - name: "SCORED | 17.9.4 | POLICY | L1 Ensure Audit Security System Extension is set to include Success"
      win_shell: AuditPol /set /subcategory:"Security System Extension" /success:enable
      when: "'Success' not in rule_17_9_4_audit.stdout"
  when: cis[2019]['17.9.4']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.4

- name: "SCORED | 17.9.5 | POLICY | L1 Ensure Audit System Integrity is set to Success and Failure"
  block:
    - name: "SCORED | 17.9.5 | AUDIT | L1 Ensure Audit System Integrity is set to Success and Failure"
      win_shell: AuditPol /get /subcategory:"System Integrity" -r | ConvertFrom-Csv | Select-Object -expand "Inclusion Setting"
      changed_when: false
      failed_when: false
      register: rule_17_9_5_audit

    - name: "SCORED | 17.9.5 | POLICY | L1 Ensure Audit System Integrity is set to Success and Failure | Success"
      win_shell: AuditPol /set /subcategory:"System Integrity" /success:enable
      changed_when: "'Success' not in rule_17_9_5_audit.stdout"
      when: "'Success' not in rule_17_9_5_audit.stdout"

    - name: "SCORED | 17.9.5 | POLICY | L1 Ensure Audit System Integrity is set to Success and Failure | Failure"
      win_shell: AuditPol /set /subcategory:"System Integrity" /failure:enable
      changed_when: "'Failure' not in rule_17_9_5_audit.stdout"
      when: "'Failure' not in rule_17_9_5_audit.stdout"
  when: cis[2019]['17.9.5']
  tags:
    - domaincontroller
    - memberserver
    - control_17.9.5
  
  # Section 18

- name: "SCORED | 18.1.1.1 | POLICY | L1 Ensure Prevent enabling lock screen camera is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Personalization
    name: NoLockScreenCamera
    data: 1
    type: dword
  when: cis[2019]['18.1.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.1.1.1

- name: "SCORED | 18.1.1.2 | POLICY | L1 Ensure Prevent enabling lock screen slide show is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Personalization
    name: NoLockScreenSlideshow
    data: 1
    type: dword
  when: cis[2019]['18.1.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.1.1.2

- name: "SCORED | 18.1.2.2 | POLICY | L1 Ensure Allow users to enable online speech recognition services is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\InputPersonalization
    name: "AllowInputPersonalization"
    data: "0"
    type: dword
  when: cis[2019]['18.1.2.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.1.2.2

- name: "SCORED | 18.2.1 | POLICY | L1 Ensure LAPS AdmPwd GPO Extension  CSE is installed MS only"
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions\{D76B9641-3288-4f75-942D-087DE603E3EA}
    name: DllName
    data: C:\Program Files\LAPS\CSE\AdmPwd.dll
    type: string
    when:
      - cis[2019]['18.2.1']
      - ansible_windows_domain_role == "Member Server"
  tags:
    - memberserver
    - control_18.2.1

- name: "SCORED | 18.2.2 | POLICY | L1 Ensure Do not allow password expiration time longer than required by policy is set to Enabled MS only"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
    name: PwdExpirationProtectionEnabled
    data: 1
    type: dword
    when:
      - cis[2019]['18.2.2']
      - ansible_windows_domain_role == "Member Server"
  tags:
    - memberserver
    - control_18.2.2

- name: "SCORED | 18.2.3 | POLICY | L1 Ensure Enable Local Admin Password Management is set to Enabled MS only"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
    name: AdmPwdEnabled
    data: 1
    type: dword
    when:
      - cis[2019]['18.2.3']
      - ansible_windows_domain_role == "Member Server"
  tags:
    - memberserver
    - control_18.2.3

- name: "SCORED | 18.2.4 | POLICY | L1 Ensure Password Settings Password Complexity is set to Enabled Large letters  small letters  numbers  special characters MS only"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
    name: PasswordComplexity
    data: 4
    type: dword
    when:
      - cis[2019]['18.2.4']
      - ansible_windows_domain_role == "Member Server"
  tags:
    - memberserver
    - control_18.2.4

- name: "SCORED | 18.2.5 | POLICY | L1 Ensure Password Settings Password Length is set to Enabled 15 or more MS only"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
    name: PasswordLength
    data: "{{ laps_passwordlength }}"
    type: dword
    when:
      - cis[2019]['18.2.5']
      - ansible_windows_domain_role == "Member Server"
  tags:
    - memberserver
    - control_18.2.5

- name: "SCORED | 18.2.6 | POLICY | L1 Ensure Password Settings Password Age Days is set to Enabled 30 or fewer MS only"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd
    name: PasswordAgeDays
    data: "{{ laps_passwordagedays }}"
    type: dword
    when:
      - cis[2019]['18.2.6']
      - ansible_windows_domain_role == "Memmber Server"
  tags:
    - memberserver
    - control_18.2.6

- name: "SCORED | 18.3.1 | POLICY | L1 Ensure Apply UAC restrictions to local accounts on network logons is set to Enabled MS only"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: LocalAccountTokenFilterPolicy
    data: 0
    type: dword
  when:
    - cis[2019]['18.3.1']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - memberserver
    - control_18.3.1

- name: "SCORED | 18.3.2 | POLICY | L1 Ensure Configure SMB v1 client driver is set to Enabled Disable driver recommended"
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\mrxsmb10
    name: Start
    data: 4
    type: dword
  when: cis[2019]['18.3.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.3.2

- name: "SCORED | 18.3.3 | POLICY | L1 Ensure Configure SMB v1 server is set to Disabled"
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
    name: SMB1
    data: 0
    type: dword
    state: present
  notify: reboot_windows
  when: cis[2019]['18.3.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.3.3

- name: "SCORED | 18.3.4 | POLICY | L1 Ensure Enable Structured Exception Handling Overwrite Protection SEHOP is set to Enabled"
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\kernel
    name: DisableExceptionChainValidation
    data: 0
    type: dword
    state: present
  when: cis[2019]['18.3.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.3.4

- name: "SCORED | 18.3.5 | POLICY | L1 Ensure Extended Protection for LDAP Authentication Domain Controllers only is set to Enabled Enabled always recommended DC Only"
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters
    name: LdapEnforceChannelBinding
    data: 1
    type: dword
  when:
    - cis[2019]['18.3.5']
    - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - control_18.3.5

- name: "SCORED | 18.3.6 | POLICY | L1 Ensure 'NetBT NodeType configuration' is set to 'Enabled: P-node recommended'"
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\NetBT\Parameters
    state: present
    value: NodeType
    data: "{{ netbt_nodetype }}"
    datatype: dword
  when: cis[2019]['18.3.6']
  tags:
    - domaincontroller
    - memberserver
    - control_18.3.6

- name: "SCORED | 18.3.7 | POLICY | L1 Ensure WDigest Authentication is set to Disabled"
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest
    state: present
    value: UseLogonCredential
    data: 0
    datatype: dword
  when: cis[2019]['18.3.7']
  tags:
    - domaincontroller
    - memberserver
    - control_18.3.7

- name: "SCORED | 18.4.1 | POLICY | L1 Ensure MSS AutoAdminLogon Enable Automatic Logon not recommended is set to Disabled"
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
    state: present
    value: AutoAdminLogon
    data: 0
    datatype: string
  when: cis[2019]['18.4.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.4.1

- name: "SCORED | 18.4.2 | POLICY | L1 Ensure MSS DisableIPSourceRouting IPv6 IP source routing protection level protects against packet spoofing is set to Enabled Highest protection source routing is completely disabled"
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters
    state: present
    value: DisableIPSourceRouting
    data: 2
    datatype: dword
  when: cis[2019]['18.4.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.4.2

- name: "SCORED | 18.4.3 | POLICY | L1 Ensure MSS DisableIPSourceRouting IP source routing protection level protects against packet spoofing is set to Enabled Highest protection source routing is completely disabled"
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
    state: present
    value: DisableIPSourceRouting
    data: 2
    datatype: dword
  when: cis[2019]['18.4.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.4.3

- name: "SCORED | 18.4.4 | POLICY | L1 Ensure MSS EnableICMPRedirect Allow ICMP redirects to override OSPF generated routes is set to Disabled"
  win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
    state: present
    value: EnableICMPRedirect
    data: 0
    datatype: dword
  when: cis[2019]['18.4.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.4.4

- name: "SCORED | 18.4.6 | POLICY | L1 Ensure MSS NoNameReleaseOnDemand Allow the computer to ignore NetBIOS name release requests except from WINS servers is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Netbt\Parameters
    state: present
    name: NoNameReleaseOnDemand
    data: 1
    type: dword
  when: cis[2019]['18.4.6']
  tags:
    - domaincontroller
    - memberserver
    - control_18.4.6

- name: "SCORED | 18.4.8 | POLICY | L1 Ensure MSS SafeDllSearchMode Enable Safe DLL search mode recommended is set to Enabled"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Control\Session Manager
    name: SafeDllSearchMode
    data: 1
    type: dword
    state: present
  when: cis[2019]['18.4.8']
  tags:
    - domaincontroller
    - memberserver
    - control_18.4.8

- name: "SCORED | 18.4.9 | POLICY | L1 Ensure MSS ScreenSaverGracePeriod The time in seconds before the screen saver grace period expires 0 recommended is set to Enabled 5 or fewer seconds"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows Nt\Currentversion\Winlogon
    name: ScreenSaverGracePeriod
    data: 5
    type: string
    state: present
  when: cis[2019]['18.4.9']
  tags:
    - domaincontroller
    - memberserver
    - control_18.4.9

- name: "SCORED | 18.4.12 | POLICY | L1 Ensure MSS WarningLevel Percentage threshold for the security event log at which the system will generate a warning is set to Enabled 90 or less"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Services\Eventlog\Security
    name: WarningLevel
    data: 90
    type: dword
  when: cis[2019]['18.4.12']
  tags:
    - domaincontroller
    - memberserver
    - control_18.4.12

- name: "SCORED | 18.5.4.1 | POLICY | L1 Ensure Turn off multicast name resolution is set to Enabled MS Only"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\DNSClient
    name: EnableMulticast
    data: 0
    type: dword
    when:
    - cis[2019]['18.5.4.1']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - domaincontroller
    - memberserver
    - control_18.5.4.1

- name: "SCORED | 18.5.8.1 | POLICY | L1 Ensure Enable insecure guest logons is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Lanmanworkstation
    name: AllowInsecureGuestAuth
    data: 0
    type: dword
  when: cis[2019]['18.5.8.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.5.8.1

- name: "SCORED | 18.5.11.2 | POLICY | L1 Ensure Prohibit installation and configuration of Network Bridge on your DNS domain network is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Network Connections
    name: NC_AllowNetBridge_NLA
    data: 0
    type: dword
  when: cis[2019]['18.5.11.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.5.11.2

- name: "SCORED | 18.5.11.3 | POLICY | L1 Ensure Prohibit use of Internet Connection Sharing on your DNS domain network is set to Enabled"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Network Connections
    name: NC_ShowSharedAccessUI
    data: 0
    type: dword
  when: cis[2019]['18.5.11.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.5.11.3

- name: "SCORED | 18.5.11.4 | POLICY | L1 Ensure Require domain users to elevate when setting a networks location is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Network Connections
    name: NC_StdDomainUserSetLocation
    data: 1
    type: dword
  when: cis[2019]['18.5.11.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.5.11.4

- name: "SCORED | 18.5.14.1 | POLICY | L1 Ensure Hardened UNC Paths is set to Enabled with Require Mutual Authentication and Require Integrity set for all NETLOGON and SYSVOL shares"
  block:
    - name: "SCORED | 18.5.14.1 | POLICY | L1 Ensure Hardened UNC Paths is set to Enabled with Require Mutual Authentication and Require Integrity set for all NETLOGON shares"
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\Networkprovider\Hardenedpaths
        name: "\\\\*\\NETLOGON"
        data: "RequireMutualAuthentication=1, RequireIntegrity=1"
        type: string

    - name: "SCORED | 18.5.14.1 | POLICY | L1 Ensure Hardened UNC Paths is set to Enabled with Require Mutual Authentication and Require Integrity set for all SYSVOL shares"
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\Networkprovider\Hardenedpaths
        name: "\\\\*\\SYSVOL"
        data: "RequireMutualAuthentication=1, RequireIntegrity=1"
        type: string
  when: cis[2019]['18.5.14.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.5.14.1

- name: "SCORED | 18.5.21.1 | POLICY | L1 Ensure Minimize the number of simultaneous connections to the Internet or a Windows Domain is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Wcmsvc\Grouppolicy
    name: fMinimizeConnections
    data: 3
    type: dword
  when: cis[2019]['18.5.21.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.5.21.1

- name: "SCORED | 18.8.3.1 | POLICY | L1 Ensure Include command line in process creation events is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System\Audit
    name: ProcessCreationIncludeCmdLine_Enabled
    data: 0
    type: dword
  when: cis[2019]['18.8.3.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.3.1

- name: "SCORED | 18.8.4.1 | POLICY | L1 Ensure Encryption Oracle Remediation is set to Enabled Force Updated Clients"
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\CredSSP\Parameters
    name: AllowEncryptionOracle
    data: 0
    type: dword
  when: cis[2019]['18.8.4.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.4.1

- name: "SCORED | 18.8.4.2 | POLICY | L1 Ensure Remote host allows delegation of non-exportable credentials is set to Enabled"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\CredentialsDelegation
    name: AllowProtectedCreds
    data: 1
    type: dword
  when: cis[2019]['18.8.4.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.4.2

- name: "SCORED | 18.8.5.1 | POLICY | NG Ensure Turn On Virtualization Based Security is set to Enabled"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: EnableVirtualizationBasedSecurity
    data: 1
    type: dword
  when: cis[2019]['18.8.5.1']
  tags:
    - ng-domaincontroller
    - ng-memberserver
    - control_18.8.5.1

- name: "SCORED | 18.8.5.2 | POLICY | NG Ensure Turn On Virtualization Based Security Select Platform Security Level is set to Secure Boot and DMA Protection"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: RequirePlatformSecurityFeatures
    data: 3
    type: dword
  when: cis[2019]['18.8.5.2']
  tags:
    - ng-domaincontroller
    - ng-memberserver
    - control_18.8.5.2

- name: "SCORED | 18.8.5.3 | POLICY | NG Ensure Turn On Virtualization Based Security Virtualization Based Protection of Code Integrity is set to Enabled with UEFI lock"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: HypervisorEnforcedCodeIntegrity
    data: 1
    type: dword
  when: cis[2019]['18.8.5.3']
  tags:
    - ng-domaincontroller
    - ng-memberserver
    - control_18.8.5.3

- name: "SCORED | 18.8.5.4 | POLICY | NG Ensure Turn On Virtualization Based Security Require UEFI Memory Attributes Table is set to True checked"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: HVCIMATRequired
    data: 1
    type: dword
  when: cis[2019]['18.8.5.4']
  tags:
    - ng-domaincontroller
    - ng-memberserver
    - control_18.8.5.4

- name: "SCORED | 18.8.5.5 | POLICY | NG Ensure Turn On Virtualization Based Security Credential Guard Configuration is set to Enabled with UEFI lock MS Only"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: LsaCfgFlags
    data: 1
    type: dword
    when:
    - cis[2019]['18.8.5.5']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - ng-memberserver
    - control_18.8.5.5

- name: "SCORED | 18.8.5.6 | POLICY | NG Ensure Turn On Virtualization Based Security Credential Guard Configuration is set to Disabled DC Only"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: LsaCfgFlags
    data: 0
    type: dword
    when:
      - cis[2019]['18.8.5.6']
      - ansible_windows_domain_role == "Primary domain controller"
  tags:
    - ng-domaincontroller
    - control_18.8.5.6

- name: "SCORED | 18.8.5.7 | POLICY | NG Ensure Turn On Virtualization Based Security Secure Launch Configuration is set to Enabled"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
    name: ConfigureSystemGuardLaunch
    data: 1
    type: dword
  when: cis[2019]['18.8.5.7']
  tags:
    - ng-domaincontroller
    - ng-memberserver
    - control_18.8.5.7

- name: "SCORED | 18.8.14.1 | POLICY | L1 Ensure Boot-Start Driver Initialization Policy is set to Enabled Good unknown and bad but critical"
  win_regedit:
    path: HKLM:\System\Currentcontrolset\Policies\Earlylaunch
    name: DriverLoadPolicy
    data: 3
    type: dword
  when: cis[2019]['18.8.14.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.14.1

- name: "SCORED | 18.8.21.2 | POLICY | L1 Ensure Configure registry policy processing Do not apply during periodic background processing is set to Enabled FALSE"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Group Policy\{35378Eac-683F-11D2-A89A-00C04Fbbcfa2}
    name: NoBackgroundPolicy
    data: 0
    type: dword
  when: cis[2019]['18.8.21.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.21.2

- name: "SCORED | 18.8.21.3 | POLICY | L1 Ensure Configure registry policy processing Process even if the Group Policy objects have not changed is set to Enabled TRUE"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Group Policy\{35378Eac-683F-11D2-A89A-00C04Fbbcfa2}
    name: NoGPOListChanges
    data: 0
    type: dword
  when: cis[2019]['18.8.21.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.21.3

- name: "SCORED | 18.8.21.4 | POLICY | L1 Ensure Continue experiences on this device is set to Disabled"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: EnableCdp
    data: 0
    type: dword
  when: cis[2019]['18.8.21.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.21.4

- name: "SCORED | 18.8.21.5 | POLICY | L1 Ensure Turn off background refresh of Group Policy is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System\DisableBkGndGroupPolicy
    state: absent
    delete_key: yes
  when: cis[2019]['18.8.21.5']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.21.5

- name: "SCORED | 18.8.22.1.1 | POLICY | L1 Ensure Turn off downloading of print drivers over HTTP is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Printers
    name: DisableWebPnPDownload
    data: 1
    type: dword
  when: cis[2019]['18.8.22.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.22.1.1

- name: "SCORED | 18.8.22.1.5 | POLICY | L1 Ensure Turn off Internet download for Web publishing and online ordering wizards is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
    name: NoWebServices
    data: 1
    type: dword
  when: cis[2019]['18.8.22.1.5']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.22.1.5

- name: "SCORED | 18.8.26.1 | POLICY | L1 Ensure Enumeration policy for external devices incompatible with Kernel DMA Protection is set to Enabled Block All"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Kernel DMA Protection
    name: DeviceEnumerationPolicy
    data: 0
    type: dword
  when: cis[2019]['18.8.26.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.26.1

- name: "SCORED | 18.8.28.1 | POLICY | L1 Ensure Block user from showing account details on sign-in is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: BlockUserFromShowingAccountDetailsOnSignin
    data: 1
    type: dword
  when: cis[2019]['18.8.28.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.28.1

- name: "SCORED | 18.8.28.2 | POLICY | L1 Ensure Do not display network selection UI is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: DontDisplayNetworkSelectionUI
    data: 1
    type: dword
  when: cis[2019]['18.8.28.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.28.2

- name: "SCORED | 18.8.28.3 | POLICY | L1 Ensure Do not enumerate connected users on domain-joined computers is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: DontEnumerateConnectedUsers
    data: 1
    type: dword
  when: cis[2019]['18.8.28.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.28.3

- name: "SCORED | 18.8.28.4 | POLICY | L1 Ensure Enumerate local users on domain-joined computers is set to Disabled MS only"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: EnumerateLocalUsers
    data: 0
    type: dword
  when: cis[2019]['18.8.28.4']
  tags:
    - memberserver
    - control_18.8.28.4

- name: "SCORED | 18.8.28.5 | POLICY | L1 Ensure Turn off app notifications on the lock screen is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: DisableLockScreenAppNotifications
    data: 1
    type: dword
  when: cis[2019]['18.8.28.5']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.28.5

- name: "SCORED | 18.8.28.6 | POLICY | L1 Ensure Turn off picture password sign-in is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: BlockDomainPicturePassword
    data: 1
    type: dword
  when: cis[2019]['18.8.28.6']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.28.6

- name: "SCORED | 18.8.28.7 | POLICY | L1 Ensure Turn on convenience PIN sign-in is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: AllowDomainPINLogon
    data: 0
    type: dword
  when: cis[2019]['18.8.28.7']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.28.7

- name: "SCORED | 18.8.34.6.3 | POLICY | L1 Ensure Require a password when a computer wakes on battery is set to Enabled"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
    name: DCSettingIndex
    data: 1
    type: dword
  when: cis[2019]['18.8.34.6.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.34.6.3

- name: "SCORED | 18.8.34.6.4 | POLICY | L1 Ensure Require a password when a computer wakes plugged in is set to Enabled"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51
    name: ACSettingIndex
    data: 1
    type: dword
  when: cis[2019]['18.8.34.6.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.34.6.4

- name: "SCORED | 18.8.36.1 | POLICY | L1 Ensure Configure Offer Remote Assistance is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: fAllowUnsolicited
    data: 0
    type: dword
  when: cis[2019]['18.8.36.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.36.1

- name: "SCORED | 18.8.36.2 | POLICY | L1 Ensure Configure Solicited Remote Assistance is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: fAllowToGetHelp
    data: 0
    type: dword
  when: cis[2019]['18.8.36.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.8.36.2

- name: "SCORED | 18.8.37.1 | POLICY | L1 Ensure Enable RPC Endpoint Mapper Client Authentication is set to Enabled MS only"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Rpc
    name: EnableAuthEpResolution
    data: 1
    type: dword
  when:
    - cis[2019]['18.8.37.1']
    - not ansible_windows_domain_role == "Primary domain controller"
  tags:
    - memberserver
    - control_18.8.37.1

- name: "SCORED | 18.9.6.1 | POLICY | L1 Ensure Allow Microsoft accounts to be optional is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: MSAOptional
    data: 1
    type: dword
  when: cis[2019]['18.9.6.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.6.1

- name: "SCORED | 18.9.8.1 | POLICY | L1 Ensure Disallow Autoplay for non-volume devices is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Explorer
    name: NoAutoplayfornonVolume
    data: 1
    type: dword
  when: cis[2019]['18.9.8.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.8.1

- name: "SCORED | 18.9.8.2 | POLICY | L1 Ensure Set the default behavior for AutoRun is set to Enabled Do not execute any autorun commands"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
    name: NoAutorun
    data: 1
    type: dword
  when: cis[2019]['18.9.8.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.8.2

- name: "SCORED | 18.9.8.3 | POLICY | L1 Ensure Turn off Autoplay is set to Enabled All drives"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
    name: NoDriveTypeAutoRun
    data: 255
    type: dword
  when: cis[2019]['18.9.8.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.8.3

- name: "SCORED | 18.9.10.1.1 | POLICY | L1 Ensure Configure enhanced anti-spoofing is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Biometrics\Facialfeatures
    name: EnhancedAntiSpoofing
    data: 1
    type: dword
  when: cis[2019]['18.9.10.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.10.1.1

- name: "SCORED | 18.9.13.1 | POLICY | L1 Ensure Turn off Microsoft consumer experiences is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Cloudcontent
    name: DisableWindowsConsumerFeatures
    data: 1
    type: dword
  when: cis[2019]['18.9.13.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.13.1

- name: "SCORED | 18.9.14.1 | POLICY | L1 Ensure Require pin for pairing is set to Enabled First Time OR Enabled Always"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Connect
    name: RequirePinForPairing
    data: 1
    type: dword
  when: cis[2019]['18.9.14.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.14.1

- name: "SCORED | 18.9.15.1 | POLICY | L1 Ensure Do not display the password reveal button is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Credui
    name: DisablePasswordReveal
    data: 1
    type: dword
  when: cis[2019]['18.9.15.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.15.1

- name: "SCORED | 18.9.15.2 | POLICY | L1 Ensure Enumerate administrator accounts on elevation is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Credui
    name: EnumerateAdministrators
    data: 0
    type: dword
  when: cis[2019]['18.9.15.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.15.2

- name: "SCORED | 18.9.16.1 | POLICY | L1 Ensure Allow Telemetry is set to Enabled 0 - Security Enterprise Only or Enabled 1 - Basic"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Datacollection
    name: AllowTelemetry
    data: 0
    type: dword
  when: cis[2019]['18.9.16.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.16.1

- name: "SCORED | 18.9.16.3 | POLICY | L1 Ensure Do not show feedback notifications is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Datacollection
    name: DoNotShowFeedbackNotifications
    data: 1
    type: dword
  when: cis[2019]['18.9.16.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.16.3

- name: "SCORED | 18.9.16.4 | POLICY | L1 Ensure Toggle user control over Insider builds is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Previewbuilds
    name: AllowBuildPreview
    data: 0
    type: dword
  when: cis[2019]['18.9.16.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.16.4

- name: "SCORED | 18.9.26.1.1 | POLICY | L1 Ensure Application Control Event Log behavior when the log file reaches its maximum size is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\EventLog\Application
    name: Retention
    data: 0
    type: string
  when: cis[2019]['18.9.26.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.26.1.1

- name: "SCORED | 18.9.26.1.2 | POLICY | L1 Ensure Application Specify the maximum log file size KB is set to Enabled 32768 or greater"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Application
    name: MaxSize
    data: 65538
    type: dword
  when: cis[2019]['18.9.26.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.26.1.2

- name: "SCORED | 18.9.26.2.1 | POLICY | L1 Ensure Security Control Event Log behavior when the log file reaches its maximum size is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Security
    name: Retention
    data: 0
    type: string
  when: cis[2019]['18.9.26.2.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.26.2.1

- name: "SCORED | 18.9.26.2.2 | POLICY | L1 Ensure Security Specify the maximum log file size KB is set to Enabled 196608 or greater"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Security
    name: MaxSize
    data: 196608
    type: dword
  when: cis[2019]['18.9.26.2.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.26.2.2

- name: "SCORED | 18.9.26.3.1 | POLICY | L1 Ensure Setup Control Event Log behavior when the log file reaches its maximum size is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Setup
    name: Retention
    data: 0
    type: string
  when: cis[2019]['18.9.26.3.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.26.3.1

- name: "SCORED | 18.9.26.3.2 | POLICY | L1 Ensure Setup Specify the maximum log file size KB is set to Enabled 32768 or greater"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\Setup
    name: MaxSize
    data: 32768
    type: dword
  when: cis[2019]['18.9.26.3.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.26.3.2

- name: "SCORED | 18.9.26.4.1 | POLICY | L1 Ensure System Control Event Log behavior when the log file reaches its maximum size is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\System
    name: Retention
    data: 0
    type: string
  when: cis[2019]['18.9.26.4.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.26.4.1

- name: "SCORED | 18.9.26.4.2 | POLICY | L1 Ensure System Specify the maximum log file size KB is set to Enabled 32768 or greater"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Eventlog\System
    name: MaxSize
    data: 65538
    type: dword
  when: cis[2019]['18.9.26.4.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.26.4.2

- name: "SCORED | 18.9.30.2 | POLICY | L1 Ensure Turn off Data Execution Prevention for Explorer is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Explorer
    name: NoDataExecutionPrevention
    data: 0
    type: dword
  when: cis[2019]['18.9.30.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.30.2

- name: "SCORED | 18.9.30.3 | POLICY | L1 Ensure Turn off heap termination on corruption is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Explorer
    name: NoHeapTerminationOnCorruption
    data: 0
    type: dword
  when: cis[2019]['18.9.30.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.30.3

- name: "SCORED | 18.9.30.4 | POLICY | L1 Ensure Turn off shell protocol protected mode is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
    name: PreXPSP2ShellProtocolBehavior
    data: 0
    type: dword
  when: cis[2019]['18.9.30.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.30.4

- name: "SCORED | 18.9.44.1 | POLICY | L1 Ensure Block all consumer Microsoft account user authentication is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\MicrosoftAccount
    name: DisableUserAuth
    data: 1
    type: dword
  when: cis[2019]['18.9.44.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.44.1

- name: "SCORED | 18.9.52.1 | POLICY | L1 Ensure Prevent the usage of OneDrive for file storage is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Onedrive
    name: DisableFileSyncNGSC
    data: 1
    type: dword
  when: cis[2019]['18.9.52.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.52.1

- name: "SCORED | 18.9.59.2.2 | POLICY | L1 Ensure Do not allow passwords to be saved is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: DisablePasswordSaving
    data: 1
    type: dword
  when: cis[2019]['18.9.59.2.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.59.2.2

- name: "SCORED | 18.9.59.3.3.2 | POLICY | L1 Ensure Do not allow drive redirection is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: fDisableCdm
    data: 1
    type: dword
  when: cis[2019]['18.9.59.3.3.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.59.3.3.2

- name: "SCORED | 18.9.59.3.9.1 | POLICY | L1 Ensure Always prompt for password upon connection is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: fPromptForPassword
    data: 1
    type: dword
  when: cis[2019]['18.9.59.3.9.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.59.3.9.1

- name: "SCORED | 18.9.59.3.9.2 | POLICY | L1 Ensure Require secure RPC communication is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: fEncryptRPCTraffic
    data: 1
    type: dword
  when: cis[2019]['18.9.59.3.9.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.59.3.9.2

- name: "SCORED | 18.9.59.3.9.3 | POLICY | L1 Ensure Require use of specific security layer for remote RDP connections is set to Enabled SSL"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: SecurityLayer
    data: 2
    type: dword
  when: cis[2019]['18.9.59.3.9.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.59.3.9.3

- name: "SCORED | 18.9.59.3.9.4 | POLICY | L1 Ensure Require user authentication for remote connections by using Network Level Authentication is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: UserAuthentication
    data: 1
    type: dword
  when: cis[2019]['18.9.59.3.9.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.59.3.9.4

- name: "SCORED | 18.9.59.3.9.5 | POLICY | L1 Ensure Set client connection encryption level is set to Enabled High Level"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: MinEncryptionLevel
    data: 3
    type: dword
  when: cis[2019]['18.9.59.3.9.5']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.59.3.9.5

- name: "SCORED | 18.9.59.3.11.1 | POLICY | L1 Ensure Do not delete temp folders upon exit is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: DeleteTempDirsOnExit
    data: 1
    type: dword
  when: cis[2019]['18.9.59.3.11.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.59.3.11.1

- name: "SCORED | 18.9.59.3.11.2 | POLICY | L1 Ensure Do not use temporary folders per session is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Nt\Terminal Services
    name: PerSessionTempDir
    data: 1
    type: dword
  when: cis[2019]['18.9.59.3.11.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.59.3.11.2

- name: "SCORED | 18.9.60.1 | POLICY | L1 Ensure Prevent downloading of enclosures is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Internet Explorer\Feeds
    name: DisableEnclosureDownload
    data: 1
    type: dword
  when: cis[2019]['18.9.60.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.60.1

- name: "SCORED | 18.9.61.3 | POLICY | L1 Ensure Allow indexing of encrypted files is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Windows Search
    name: AllowIndexingEncryptedStoresOrItems
    data: 0
    type: dword
  when: cis[2019]['18.9.61.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.61.3

- name: "SCORED | 18.9.77.3.1 | POLICY | L1 Ensure Configure local setting override for reporting to Microsoft MAPS is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender\Spynet
    name: LocalSettingOverrideSpynetReporting
    data: 0
    type: dword
  when: cis[2019]['18.9.77.3.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.77.3.1

- name: "SCORED | 18.9.77.7.1 | POLICY | L1 Ensure Turn on behavior monitoring is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender\Real-Time Protection
    name: DisableBehaviorMonitoring
    data: 0
    type: dword
  when: cis[2019]['18.9.77.7.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.77.7.1

- name: "SCORED | 18.9.77.10.1 | POLICY | L1 Ensure Scan removable drives is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender\Scan
    name: DisableRemovableDriveScanning
    data: 0
    type: dword
  when: cis[2019]['18.9.77.10.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.77.10.1

- name: "SCORED | 18.9.77.10.2 | POLICY | L1 Ensure Turn on e-mail scanning is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender\Scan
    name: DisableEmailScanning
    data: 0
    type: dword
  when: cis[2019]['18.9.77.10.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.77.10.2

- name: "SCORED | 18.9.77.13.1.1 | POLICY | L1 Ensure Configure Attack Surface Reduction rules is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\ASR
    name: ExploitGuard_ASR_Rules
    data: 1
    type: dword
  when: cis[2019]['18.9.77.13.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.77.13.1.1

- name: "SCORED | 18.9.77.13.1.2 | POLICY | L1 Ensure Configure Attack Surface Reduction rules Set the state for each ASR rule is configured"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\ASR\Rules
    name: "{{ item }}"
    data: 1
    type: string
  loop:
    - 26190899-1602-49e8-8b27-eb1d0a1ce869
    - 3b576869-a4ec-4529-8536-b80a7769e899
    - 5beb7efe-fd9a-4556-801d-275e5ffc04cc
    - 75668c1f-73b5-4cf0-bb93-3ecf5cb7cc84
    - 7674ba52-37eb-4a4f-a9a1-f0f9a1619a2c
    - 92e97fa1-2edf-4476-bdd6-9dd0b4dddc7b
    - 9e6c4e1f-7d60-472f-ba1a-a39ef669e4b2
    - b2b3f03d-6a65-4f7b-a9c7-1c7ef74a9ba4
    - be9ba2d9-53ea-4cdc-84e5-9b1eeee46550
    - d3e037e1-3eb8-44c8-a917-57927947596d
    - d4f940ab-401b-4efc-aadc-ad5f3c50688a
  when: cis[2019]['18.9.77.13.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.77.13.1.2

- name: "SCORED | 18.9.77.13.3.1 | POLICY | L1 Ensure Prevent users and apps from accessing dangerous websites is set to Enabled Block"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Network Protection
    name: EnableNetworkProtection
    data: 1
    type: dword
  when: cis[2019]['18.9.77.13.3.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.77.13.3.1

- name: "SCORED | 18.9.77.14 | POLICY | L1 Ensure Configure detection for potentially unwanted applications is set to Enabled Block"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender
    name: PUAProtection
    data: 1
    type: dword
  when: cis[2019]['18.9.77.14']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.77.14

- name: "SCORED | 18.9.77.15 | POLICY | L1 Ensure Turn off Windows Defender AntiVirus is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender
    name: DisableAntiSpyware
    data: 0
    type: dword
  when: cis[2019]['18.9.77.15']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.77.15

- name: "SCORED | 18.9.80.1.1 | POLICY | L1 Ensure Configure Windows Defender SmartScreen is set to Enabled Warn and prevent bypass"
  block:
    - name: "SCORED | 18.9.80.1.1 | POLICY | L1 Ensure Configure Windows Defender SmartScreen is set to Enabled Warn and prevent bypass | EnableSmartScreen"
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\System
        name: EnableSmartScreen
        data: 1
        type: dword

    - name: "SCORED | 18.9.80.1.1 | POLICY | L1 Ensure Configure Windows Defender SmartScreen is set to Enabled Warn and prevent bypass | ShellSmartScreenLevel"
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\System
        name: ShellSmartScreenLevel
        data: Block
        type: string
  when: cis[2019]['18.9.80.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.80.1.1

- name: "SCORED | 18.9.84.2 | POLICY | L1 Ensure Allow Windows Ink Workspace is set to Enabled On but disallow access above lock OR Disabled but not Enabled On"
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsInkWorkspace
    name: AllowWindowsInkWorkspace
    data: 1
    type: dword
  when: cis[2019]['18.9.84.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.84.2

- name: "SCORED | 18.9.85.1 | POLICY | L1 Ensure Allow user control over installs is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Installer
    name: EnableUserControl
    data: 0
    type: dword
  when: cis[2019]['18.9.85.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.85.1

- name: "SCORED | 18.9.85.2 | POLICY | L1 Ensure Always install with elevated privileges is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Installer
    name: AlwaysInstallElevated
    data: 0
    type: dword
  when: cis[2019]['18.9.85.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.85.2

- name: "SCORED | 18.9.86.1 | POLICY | L1 Ensure Sign-in last interactive user automatically after a system-initiated restart is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Microsoft\Windows\Currentversion\Policies\System
    name: DisableAutomaticRestartSignOn
    data: 1
    type: dword
  when: cis[2019]['18.9.86.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.86.1

- name: "SCORED | 18.9.95.1 | POLICY | L1 Ensure Turn on PowerShell Script Block Logging is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Powershell\Scriptblocklogging
    name: EnableScriptBlockLogging
    data: 0
    type: dword
  when: cis[2019]['18.9.95.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.95.1

- name: "SCORED | 18.9.95.2 | POLICY | L1 Ensure Turn on PowerShell Transcription is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Powershell\Transcription
    name: EnableTranscripting
    data: 0
    type: dword
  when: cis[2019]['18.9.95.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.95.2

- name: "SCORED | 18.9.97.1.1 | POLICY | L1 Ensure Allow Basic authentication is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Client
    name: AllowBasic
    data: 0
    type: dword
  when:
    - cis[2019]['18.9.97.1.1']
    - not win_skip_for_test
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.97.1.1

- name: "SCORED | 18.9.97.1.2 | POLICY | L1 Ensure Allow unencrypted traffic is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Client
    name: AllowUnencryptedTraffic
    data: 0
    type: dword
    when:
      - cis[2019]['18.9.97.1.2']
      - not win_skip_for_test
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.97.1.2

- name: "SCORED | 18.9.97.1.3 | POLICY | L1 Ensure Disallow Digest authentication is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Client
    name: AllowDigest
    data: 0
    type: dword
  when: cis[2019]['18.9.97.1.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.97.1.3

- name: "SCORED | 18.9.97.2.1 | POLICY | L1 Ensure Allow Basic authentication is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Service
    name: AllowBasic
    data: 0
    type: dword
    when:
      - cis[2019]['18.9.97.2.1']
      - not win_skip_for_test
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.97.2.1

- name: "SCORED | 18.9.97.2.3 | POLICY | L1 Ensure Allow unencrypted traffic is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Service
    name: AllowUnencryptedTraffic
    data: 0
    type: dword
    when:
      - cis[2019]['18.9.97.2.3']
      - not win_skip_for_test
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.97.2.3

- name: "SCORED | 18.9.97.2.4 | POLICY | L1 Ensure Disallow WinRM from storing RunAs credentials is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Winrm\Service
    name: DisableRunAs
    data: 1
    type: dword
  when: cis[2019]['18.9.97.2.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.97.2.4

- name: "SCORED | 18.9.99.2.1 | POLICY | L1 Ensure Prevent users from modifying settings is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender Security Center\App and Browser protection
    name: DisallowExploitProtectionOverride
    data: 1
    type: dword
  when: cis[2019]['18.9.99.2.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.99.2.1

- name: "SCORED | 18.9.102.1.1 | POLICY | L1 Ensure Manage preview builds is set to Enabled Disable preview builds"
  block:
    - name: "SCORED | 18.9.102.1.1 | POLICY | L1 Ensure Manage preview builds is set to Enabled Disable preview builds | ManagePreviewBuilds"
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
        name: ManagePreviewBuilds
        data: 1
        type: dword

    - name: "SCORED | 18.9.102.1.1 | POLICY | L1 Ensure Manage preview builds is set to Enabled Disable preview builds | ManagePreviewBuilds"
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
        name: ManagePreviewBuildsPolicyValue
        data: 0
        type: dword
  when: cis[2019]['18.9.102.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.102.1.1

- name: "SCORED | 18.9.102.1.2 | POLICY | L1 Ensure Select when Preview Builds and Feature Updates are received is set to Enabled Semi-Annual Channel 180 or more days"
  block:
    - name: "SCORED | 18.9.102.1.2 | POLICY | L1 Ensure Select when Preview Builds and Feature Updates are received is set to Enabled Semi-Annual Channel 180 or more days | DeferFeatureUpdates"
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
        name: DeferFeatureUpdates
        data: 1
        type: dword

    - name: "SCORED | 18.9.102.1.2 | POLICY | L1 Ensure Select when Preview Builds and Feature Updates are received is set to Enabled Semi-Annual Channel 180 or more days | DeferFeatureUpdatesPeriodInDays"
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
        name: DeferFeatureUpdatesPeriodInDays
        data: 180
        type: dword

    - name: "SCORED | 18.9.102.1.2 | POLICY | L1 Ensure Select when Preview Builds and Feature Updates are received is set to Enabled Semi-Annual Channel 180 or more days | BranchReadinessLevel"
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate
        name: BranchReadinessLevel
        data: 16
        type: dword
  when: cis[2019]['18.9.102.1.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.102.1.2

- name: "SCORED | 18.9.102.1.3 | POLICY | L1 Ensure Select when Quality Updates are received is set to Enabled 0 days"
  block:
    - name: "SCORED | 18.9.102.1.3 | POLICY | L1 Ensure Select when Quality Updates are received is set to Enabled 0 days | DeferQualityUpdates"
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
        name: DeferQualityUpdates
        data: 1
        type: dword

    - name: "SCORED | 18.9.102.1.3 | POLICY | L1 Ensure Select when Quality Updates are received is set to Enabled 0 days | DeferQualityUpdatesPeriodInDays"
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
        name: DeferQualityUpdatesPeriodInDays
        data: 0
        type: dword
  when: cis[2019]['18.9.102.1.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.102.1.3

- name: "SCORED | 18.9.102.2 | POLICY | L1 Ensure Configure Automatic Updates is set to Enabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Windowsupdate\Au
    name: NoAutoUpdate
    data: 0
    type: dword
  when: cis[2019]['18.9.102.2']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.102.2

- name: "SCORED | 18.9.102.3 | POLICY | L1 Ensure Configure Automatic Updates Scheduled install day is set to 0 - Every day"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Windowsupdate\Au
    name: ScheduledInstallDay
    data: 0
    type: dword
  when: cis[2019]['18.9.102.3']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.102.3

- name: "SCORED | 18.9.102.4 | POLICY | L1 Ensure No auto-restart with logged on users for scheduled automatic updates installations is set to Disabled"
  win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Windowsupdate\Au
    name: NoAutoRebootWithLoggedOnUsers
    data: 0
    type: dword
  when: cis[2019]['18.9.102.4']
  tags:
    - domaincontroller
    - memberserver
    - control_18.9.102.4

# Section 19

- name: "SCORED | 19.1.3.1 | POLICY | L1 Ensure Enable screen saver is set to Enabled"
  block:
    - name: "SCORED | 19.1.3.1 | POLICY | L1 Ensure Enable screen saver is set to Enabled"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Policies\Microsoft\Windows\Control Panel\Desktop
        name: ScreenSaveActive
        data: 1
        type: string

    - name: "SCORED | 19.1.3.1 | POLICY | L1 Ensure Enable screen saver is set to Enabled"
      win_regedit:
        path: HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop
        name: ScreenSaveActive
        data: 1
        type: string
  when: cis[2019]['19.1.3.1']
  tags:
    - domaincontroller
    - memberserver
    - control_19.1.3.1

- name: "SCORED | 19.1.3.2 | POLICY | L1 Ensure Force specific screen saver Screen saver executable name is set to Enabled scrnsave.scr"
  block:
    - name: "SCORED | 19.1.3.2 | POLICY | L1 Ensure Force specific screen saver Screen saver executable name is set to Enabled scrnsave.scr"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Policies\Microsoft\Windows\Control Panel\Desktop
        name: SCRNSAVE.EXE
        data: scrnsave.scr
        type: string

    - name: "SCORED | 19.1.3.2 | POLICY | L1 Ensure Force specific screen saver Screen saver executable name is set to Enabled scrnsave.scr"
      win_regedit:
        path: HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop
        name: SCRNSAVE.EXE
        data: scrnsave.scr
        type: string
  when: cis[2019]['19.1.3.2']
  tags:
    - domaincontroller
    - memberserver
    - control_19.1.3.2

- name: "SCORED | 19.1.3.3 | POLICY | L1 Ensure Password protect the screen saver is set to Enabled"
  block:
    - name: "SCORED | 19.1.3.3 | POLICY | L1 Ensure Password protect the screen saver is set to Enabled"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Policies\Microsoft\Windows\Control Panel\Desktop
        name: ScreenSaverIsSecure
        data: 1
        type: string

    - name: "SCORED | 19.1.3.3 | POLICY | L1 Ensure Password protect the screen saver is set to Enabled"
      win_regedit:
        path: HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop
        name: ScreenSaverIsSecure
        data: 1
        type: string
  when: cis[2019]['19.1.3.3']
  tags:
    - domaincontroller
    - memberserver
    - control_19.1.3.3

- name: "SCORED | 19.1.3.4 | POLICY | L1 Ensure Screen saver timeout is set to Enabled 900 seconds or fewer but not 0"
  block:
    - name: "SCORED | 19.1.3.4 | POLICY | L1 Ensure Screen saver timeout is set to Enabled 900 seconds or fewer but not 0"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Policies\Microsoft\Windows\Control Panel\Desktop
        name: ScreenSaveTimeOut
        data: 900
        type: string

    - name: "SCORED | 19.1.3.4 | POLICY | L1 Ensure Screen saver timeout is set to Enabled 900 seconds or fewer but not 0"
      win_regedit:
        path: HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop
        name: ScreenSaveTimeOut
        data: 900
        type: string
  when: cis[2019]['19.1.3.4']
  tags:
    - domaincontroller
    - memberserver
    - control_19.1.3.4

- name: "SCORED | 19.5.1.1 | POLICY | L1 Ensure Turn off toast notifications on the lock screen is set to Enabled"
  block:
    - name: "SCORED | 19.5.1.1 | POLICY | L1 Ensure Turn off toast notifications on the lock screen is set to Enabled"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Policies\Microsoft\Windows\Currentversion\Pushnotifications
        name: NoToastApplicationNotificationOnLockScreen
        data: 1
        type: dword

    - name: "SCORED | 19.5.1.1 | POLICY | L1 Ensure Turn off toast notifications on the lock screen is set to Enabled"
      win_regedit:
        path: HKCU:\Software\Policies\Microsoft\Windows\Currentversion\Pushnotifications
        name: NoToastApplicationNotificationOnLockScreen
        data: 1
        type: dword
  when: cis[2019]['19.5.1.1']
  tags:
    - domaincontroller
    - memberserver
    - control_19.5.1.1

- name: "SCORED | 19.7.4.1 | POLICY | L1 Ensure Do not preserve zone information in file attachments is set to Disabled"
  block:
    - name: "SCORED | 19.7.4.1 | POLICY | L1 Ensure Do not preserve zone information in file attachments is set to Disabled"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments
        name: SaveZoneInformation
        data: 2
        type: dword

    - name: "SCORED | 19.7.4.1 | POLICY | L1 Ensure Do not preserve zone information in file attachments is set to Disabled"
      win_regedit:
        path: HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments
        name: SaveZoneInformation
        data: 2
        type: dword
  when: cis[2019]['19.7.4.1']
  tags:
    - domaincontroller
    - memberserver
    - control_19.7.4.1

- name: "SCORED | 19.7.4.2 | POLICY | L1 Ensure Notify antivirus programs when opening attachments is set to Enabled"
  block:
    - name: "SCORED | 19.7.4.2 | POLICY | L1 Ensure Notify antivirus programs when opening attachments is set to Enabled"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Microsoft\Windows\Currentversion\Policies\Attachments
        name: ScanWithAntiVirus
        data: 3
        type: dword

    - name: "SCORED | 19.7.4.2 | POLICY | L1 Ensure Notify antivirus programs when opening attachments is set to Enabled"
      win_regedit:
        path: HKCU:\Software\Microsoft\Windows\Currentversion\Policies\Attachments
        name: ScanWithAntiVirus
        data: 3
        type: dword
  when: cis[2019]['19.7.4.2']
  tags:
    - domaincontroller
    - memberserver
    - control_19.7.4.2

- name: "SCORED | 19.7.7.1 | POLICY | L1 Ensure Configure Windows spotlight on lock screen is set to Disabled"
  block:
    - name: "SCORED | 19.7.7.1 | POLICY | L1 Ensure Configure Windows spotlight on lock screen is set to Disabled"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Policies\Microsoft\Windows\CloudContent
        name: ConfigureWindowsSpotlight
        data: 2
        type: dword

    - name: "SCORED | 19.7.7.1 | POLICY | L1 Ensure Configure Windows spotlight on lock screen is set to Disabled"
      win_regedit:
        path: HKCU:\Software\Policies\Microsoft\Windows\CloudContent
        name: ConfigureWindowsSpotlight
        data: 2
        type: dword
  when: cis[2019]['19.7.7.1']
  tags:
    - domaincontroller
    - memberserver
    - control_19.7.7.1

- name: "SCORED | 19.7.7.2 | POLICY | L1 Ensure Do not suggest third-party content in Windows spotlight is set to Enabled"
  block:
    - name: "SCORED | 19.7.7.2 | POLICY | L1 Ensure Do not suggest third-party content in Windows spotlight is set to Enabled"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Policies\Microsoft\Windows\CloudContent
        name: DisableThirdPartySuggestions
        data: 1
        type: dword

    - name: "SCORED | 19.7.7.2 | POLICY | L1 Ensure Do not suggest third-party content in Windows spotlight is set to Enabled"
      win_regedit:
        path: HKCU:\Software\Policies\Microsoft\Windows\CloudContent
        name: DisableThirdPartySuggestions
        data: 1
        type: dword
  when: cis[2019]['19.7.7.2']
  tags:
    - domaincontroller
    - memberserver
    - control_19.7.7.2

- name: "SCORED | 19.7.26.1 | POLICY | L1 Ensure Prevent users from sharing files within their profile. is set to Enabled"
  block:
    - name: "SCORED | 19.7.26.1 | POLICY | L1 Ensure Prevent users from sharing files within their profile. is set to Enabled"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Microsoft\Windows\Currentversion\Policies\Explorer
        name: NoInplaceSharing
        data: 1
        type: dword

    - name: "SCORED | 19.7.26.1 | POLICY | L1 Ensure Prevent users from sharing files within their profile. is set to Enabled"
      win_regedit:
        path: HKCU:\Software\Microsoft\Windows\Currentversion\Policies\Explorer
        name: NoInplaceSharing
        data: 1
        type: dword
  when: cis[2019]['19.7.26.1']
  tags:
    - domaincontroller
    - memberserver
    - control_19.7.26.1

- name: "SCORED | 19.7.41.1 | POLICY | L1 Ensure Always install with elevated privileges is set to Disabled"
  block:
    - name: "SCORED | 19.7.41.1 | POLICY | L1 Ensure Always install with elevated privileges is set to Disabled"
      win_regedit:
        path: HKU:\.DEFAULT\Software\Policies\Microsoft\Windows\Installer
        name: AlwaysInstallElevated
        data: 0
        type: dword

    - name: "SCORED | 19.7.41.1 | POLICY | L1 Ensure Always install with elevated privileges is set to Disabled"
      win_regedit:
        path: HKCU:\Software\Policies\Microsoft\Windows\Installer
        name: AlwaysInstallElevated
        data: 0
        type: dword
  when: cis[2019]['19.7.41.1']
  tags:
    - domaincontroller
    - memberserver
    - control_19.7.41.1